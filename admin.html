<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    .fade-in { animation: fade .25s ease-out; }
    @keyframes fade { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }
    .thumb { width:64px; height:64px; object-fit:cover; border-radius:8px; }
  </style>
</head>
<body class="bg-pink-50 text-black font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="fixed top-0 w-full flex justify-between items-center px-6 py-4 bg-pink-100 shadow z-50">
    <h1 class="text-xl font-bold uppercase text-rose-600">Admin • The Footballer’s Sister</h1>
    <nav class="space-x-6">
      <a href="index.html" class="hover:underline text-rose-600">Home</a>
    </nav>
  </header>

  <!-- LOGIN -->
  <main id="loginSection" class="flex-grow pt-32 px-6 pb-20">
    <div class="max-w-sm mx-auto bg-white rounded-xl shadow p-6 fade-in">
      <h2 class="text-2xl font-bold text-rose-700 mb-2">Admin Login</h2>
      <p class="text-sm text-gray-600 mb-4">Sign in with your admin email & password.</p>

      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" required placeholder="Email"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <input id="password" type="password" required placeholder="Password"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <button class="w-full bg-rose-600 text-white px-6 py-3 rounded-full hover:bg-rose-700 font-semibold">
          Log in
        </button>
      </form>

      <p id="loginError" class="text-red-600 text-sm mt-3 hidden"></p>
    </div>
  </main>

  <!-- NO ACCESS -->
  <section id="noAccess" class="hidden flex-grow pt-32 px-6 pb-20 text-center">
    <h2 class="text-2xl font-bold text-rose-700 mb-2">No Access</h2>
    <p class="text-gray-700">This account is not authorized to use the admin panel.</p>
    <button id="logoutNoAccess" class="mt-6 bg-gray-200 text-gray-900 px-4 py-2 rounded-full hover:bg-gray-300">Log out</button>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="adminPanel" class="hidden flex-grow pt-32 px-6 pb-20 max-w-6xl mx-auto fade-in">
    <div class="flex items-center justify-between mb-6">
      <div class="flex flex-wrap gap-3">
        <button data-tab="support"  class="tab-btn bg-rose-600 text-white px-4 py-2 rounded-full">Support Wall</button>
        <button data-tab="qa"       class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Q&A</button>
        <button data-tab="fixtures" class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Fixtures</button>
        <button data-tab="media"    class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Media / Gallery</button>
      </div>
      <div class="flex items-center gap-3">
        <span id="adminUidDisplay" class="text-xs text-gray-600 hidden"></span>
        <button id="logoutBtn" class="bg-rose-600 text-white px-4 py-2 rounded-full hover:bg-rose-700">Log out</button>
      </div>
    </div>

    <!-- Support Wall -->
    <div id="tab-support">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Support Wall – Moderate</h2>
      <div id="supportList" class="space-y-3"><p class="text-gray-500">Loading…</p></div>
    </div>

    <!-- Q&A -->
    <div id="tab-qa" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-rose-700">Q&A – Answer & Moderate</h2>
        <div class="flex gap-2">
          <button data-filter="all"         class="qa-filter px-3 py-1 rounded-full bg-rose-600 text-white">All</button>
          <button data-filter="unanswered"  class="qa-filter px-3 py-1 rounded-full bg-gray-200 text-gray-900">Unanswered</button>
          <button data-filter="answered"    class="qa-filter px-3 py-1 rounded-full bg-gray-200 text-gray-900">Answered</button>
        </div>
      </div>
      <p id="qaCounts" class="text-xs text-gray-500 mb-2">Totals: —</p>
      <div id="qaList" class="space-y-3"><p class="text-gray-500">Loading…</p></div>
    </div>

    <!-- FIXTURES -->
    <div id="tab-fixtures" class="hidden">
      <h2 class="text-2xl font-bold text-rose-700 mb-4">Fixtures – Add / Update</h2>
      <!-- (Your fixtures UI is kept here — same as before) -->
      <p class="text-sm text-gray-600">Fixtures UI retained (unchanged) — use this panel to add/edit games, live scores and stream links.</p>
      <div id="fxList" class="mt-4 space-y-3"></div>
    </div>

    <!-- MEDIA / GALLERY -->
    <div id="tab-media" class="hidden">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Media / Gallery – Upload & Manage</h2>

      <!-- Upload Form -->
      <div class="bg-white border rounded-2xl p-4 shadow mb-6">
        <form id="uploadForm" class="grid gap-3 md:grid-cols-2 items-end">
          <div>
            <label class="text-sm block mb-1">Choose image</label>
            <input id="fileInput" type="file" accept="image/*" class="w-full" />
            <img id="filePreview" class="mt-3 thumb hidden" alt="preview">
          </div>

          <div>
            <label class="text-sm block mb-1">Caption</label>
            <input id="fileCaption" type="text" placeholder="Short caption (e.g., 'Pre-match shoot')" class="w-full border rounded px-3 py-2" />
          </div>

          <div>
            <label class="text-sm block mb-1">Order (smaller numbers show first)</label>
            <input id="fileOrder" type="number" value="10" class="w-full border rounded px-3 py-2" />
          </div>

          <div class="flex gap-2">
            <button id="uploadBtn" class="bg-rose-600 text-white px-4 py-2 rounded hover:bg-rose-700">Upload to Cloud & Save</button>
            <button id="resetUpload" type="button" class="bg-gray-200 px-4 py-2 rounded">Reset</button>
          </div>

          <div class="md:col-span-2">
            <div class="w-full bg-gray-100 rounded overflow-hidden mt-2">
              <div id="uploadProgress" class="h-2 bg-rose-600 w-0 transition-all"></div>
            </div>
            <p id="uploadMsg" class="text-xs text-gray-600 mt-2"></p>
          </div>
        </form>
      </div>

      <!-- Gallery list -->
      <div id="galleryList" class="space-y-3">
        <p class="text-gray-500">Loading gallery…</p>
      </div>
    </div>
  </section>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; <span id="year"></span> The Footballer’s Sister. All rights reserved.</p>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- FIREBASE + CLOUDINARY -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, addDoc,
      serverTimestamp, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG / CONSTANTS ---
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2"; // your admin UID
    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db"
    };

    // Short APP ID used in your public data path
    const APP_ID_SHORT = "1:65396604482:web:0f31625a714aa8352337db";
    const BASE_PATH = `artifacts/${APP_ID_SHORT}/public/data`;
    const SUPPORT_PATH = `${BASE_PATH}/supportMessages`;
    const QUESTIONS_PATH = `${BASE_PATH}/questions`;
    const FIXTURES_PATH = `${BASE_PATH}/fixtures`;
    const GALLERY_PATH = `${BASE_PATH}/gallery`;

    // Cloudinary (unsigned preset)
    const CLOUDINARY_CLOUD = "dk1df1qmi";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_bts_preset";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // UI refs
    const loginSection = document.getElementById('loginSection');
    const adminPanel   = document.getElementById('adminPanel');
    const noAccess     = document.getElementById('noAccess');
    const loginForm    = document.getElementById('loginForm');
    const loginError   = document.getElementById('loginError');
    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutNo     = document.getElementById('logoutNoAccess');
    const adminUidDisplay = document.getElementById('adminUidDisplay');

    // support & qa refs
    const supportList  = document.getElementById('supportList');
    const qaList       = document.getElementById('qaList');
    const qaCountsEl   = document.getElementById('qaCounts');

    // gallery refs
    const uploadForm   = document.getElementById('uploadForm');
    const fileInput    = document.getElementById('fileInput');
    const filePreview  = document.getElementById('filePreview');
    const fileCaption  = document.getElementById('fileCaption');
    const fileOrder    = document.getElementById('fileOrder');
    const uploadBtn    = document.getElementById('uploadBtn');
    const resetUpload  = document.getElementById('resetUpload');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadMsg    = document.getElementById('uploadMsg');
    const galleryList  = document.getElementById('galleryList');

    // internal state
    let currentUser = null;
    let qaItems = [];
    let qaFilter = 'all';

    // helper escape
    const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));

    // UI helpers
    function setView(v){
      loginSection.classList.toggle('hidden', v !== 'login');
      adminPanel.classList.toggle('hidden', v !== 'admin');
      noAccess.classList.toggle('hidden', v !== 'noaccess');
    }

    // Auth flow
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (!user) return setView('login');
      // user signed in
      if (user.uid === ADMIN_UID) {
        adminUidDisplay.textContent = `UID: ${user.uid}`;
        adminUidDisplay.classList.remove('hidden');
        setView('admin');
        startListeners();
      } else {
        setView('noaccess');
      }
    });

    // Login form
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');
      try {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err) {
        loginError.textContent = err.message || 'Login failed';
        loginError.classList.remove('hidden');
      }
    });

    logoutBtn.onclick = () => signOut(auth);
    logoutNo.onclick = () => signOut(auth);

    /* ---------------- Support Wall Moderation ---------------- */
    function renderSupport(list){
      supportList.innerHTML = '';
      if (!list.length) return supportList.innerHTML = '<p class="text-gray-500">No messages yet.</p>';
      list.forEach(({ id, data }) => {
        supportList.innerHTML += `
          <div class="bg-white border rounded-2xl p-4 shadow">
            <strong>${esc(data.name||'Anonymous')}</strong>
            <p class="text-gray-700 mt-1">${esc(data.message||'')}</p>
            <div class="mt-2 flex gap-2">
              <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="deleteSupport('${id}')">Delete</button>
            </div>
          </div>`;
      });
    }
    window.deleteSupport = async id => {
      if (!confirm('Delete message?')) return;
      await deleteDoc(doc(db, SUPPORT_PATH, id));
    };

    /* ---------------- Q&A Moderation ---------------- */
    function applyFilter(items, filter){
      if (filter === 'answered') return items.filter(x => !!x.data.answer);
      if (filter === 'unanswered') return items.filter(x => !x.data.answer);
      return items;
    }
    function renderQACounts(items){
      const total = items.length;
      const answered = items.filter(x => !!x.data.answer).length;
      const unanswered = total - answered;
      qaCountsEl.textContent = `Totals: All ${total} • Unanswered ${unanswered} • Answered ${answered}`;
    }
    function renderQuestions(){
      const items = applyFilter(qaItems, qaFilter);
      renderQACounts(qaItems);

      qaList.innerHTML = '';
      if (!items.length) return qaList.innerHTML = '<p class="text-gray-500">No questions yet.</p>';

      items.forEach(({ id, data }) => {
        qaList.innerHTML += `
          <div class="bg-white border rounded-2xl p-4 shadow">
            <strong>${esc(data.name||'Anonymous')}</strong>
            <p class="text-gray-800 mt-1">${esc(data.question||'')}</p>
            ${data.answer ? 
              `<div class="bg-pink-50 mt-2 p-2 rounded"><strong>Answer:</strong> ${esc(data.answer)}</div>` :
              `<textarea id="ans-${id}" class="border w-full p-2 mt-2 rounded" placeholder="Type your answer"></textarea>
               <button class="bg-rose-600 text-white px-3 py-1 mt-2 rounded" onclick="saveAnswer('${id}')">Save Answer</button>`}
            <div class="mt-2">
              <button class="mt-2 bg-red-600 text-white px-3 py-1 rounded" onclick="deleteQuestion('${id}')">Delete</button>
            </div>
          </div>`;
      });
    }
    window.deleteQuestion = async id => {
      if (!confirm('Delete question?')) return;
      await deleteDoc(doc(db, QUESTIONS_PATH, id));
    };
    window.saveAnswer = async id => {
      const ans = document.getElementById('ans-'+id)?.value.trim();
      if (!ans) return alert('Please write an answer.');
      await updateDoc(doc(db, QUESTIONS_PATH, id), { answer: ans, answeredAt: serverTimestamp() });
      alert('Answer saved!');
    };

    /* ---------------- Fixtures (kept simple) ---------------- */
    // A minimal listener to show fixtures in admin — your full fixtures UI (add/edit) can be re-used from prior file
    function renderFixturesList(docs) {
      const fxList = document.getElementById('fxList');
      fxList.innerHTML = '';
      if (!docs.length) return fxList.innerHTML = '<p class="text-gray-500">No fixtures yet.</p>';
      docs.forEach(d=>{
        const data = d.data();
        fxList.innerHTML += `<div class="bg-white border rounded p-3 shadow flex items-center gap-3">
          <img src="${esc(data.teamLogo || '')}" class="thumb" alt="">
          <div class="flex-1">
            <div class="text-sm text-gray-500">${new Date((data.kickoffTs?.seconds || 0) * 1000).toLocaleString()}</div>
            <div class="font-semibold">Jomo Cosmos ${esc(data.level||'')} vs ${esc(data.opponent||'')}</div>
            <div class="text-xs text-gray-600">${esc(data.venue||'')}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded bg-gray-200" onclick="editFixture('${d.id}')">Edit</button>
            <button class="px-3 py-1 rounded bg-red-600 text-white" onclick="deleteFixture('${d.id}')">Delete</button>
          </div>
        </div>`;
      });
    }
    window.deleteFixture = async id => { if (!confirm('Delete fixture?')) return; await deleteDoc(doc(db, FIXTURES_PATH, id)); };
    window.editFixture = id => { alert('Open fixture in Fixtures panel to edit: ' + id); };

    /* ---------------- MEDIA / GALLERY ---------------- */

    // Build XHR upload to Cloudinary (unsigned) with progress
    function uploadToCloudinary(file, onProgress) {
      return new Promise((resolve, reject) => {
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/upload`;
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        xhr.open('POST', url, true);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable && onProgress) {
            onProgress(Math.round((e.loaded / e.total) * 100));
          }
        };

        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const res = JSON.parse(xhr.responseText);
              resolve(res);
            } catch (e) { reject(e); }
          } else {
            reject(new Error('Upload failed: ' + xhr.statusText));
          }
        };

        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(fd);
      });
    }

    // Render gallery admin list
    function renderGallery(items) {
      galleryList.innerHTML = '';
      if (!items.length) return galleryList.innerHTML = '<p class="text-gray-500">No gallery images yet.</p>';
      items.forEach(item => {
        galleryList.innerHTML += `
          <div class="bg-white border rounded-2xl p-3 shadow flex items-center gap-3">
            <img src="${esc(item.data.imageUrl||'')}" class="thumb" alt="">
            <div class="flex-1">
              <div class="font-semibold text-sm">${esc(item.data.caption||'')}</div>
              <div class="text-xs text-gray-500">Order: ${esc(item.data.order ?? '')}</div>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-1 rounded bg-gray-200" onclick="editGallery('${item.id}')">Edit</button>
              <button class="px-3 py-1 rounded bg-red-600 text-white" onclick="deleteGallery('${item.id}')">Delete</button>
            </div>
          </div>
        `;
      });
    }

    window.editGallery = async (id) => {
      // fetch doc, populate form so admin can edit and save via update
      const dref = doc(db, GALLERY_PATH, id);
      const d = await (await getDocs(query(collection(db, GALLERY_PATH)))).docs.find(dd => dd.id === id); 
      // simple approach: prompt fields (you can improve to inline form)
      const newCaption = prompt('New caption:');
      const newOrder = prompt('New order (number):');
      if (newCaption !== null) {
        await updateDoc(dref, { caption: newCaption, order: Number(newOrder || 0) });
        alert('Updated');
      }
    };

    window.deleteGallery = async id => {
      if (!confirm('Delete this gallery image?')) return;
      await deleteDoc(doc(db, GALLERY_PATH, id));
    };

    // Upload form behavior
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) { filePreview.classList.add('hidden'); return; }
      const url = URL.createObjectURL(f);
      filePreview.src = url;
      filePreview.classList.remove('hidden');
    });

    resetUpload.addEventListener('click', () => {
      fileInput.value = '';
      filePreview.src = '';
      filePreview.classList.add('hidden');
      fileCaption.value = '';
      fileOrder.value = '10';
      uploadProgress.style.width = '0%';
      uploadMsg.textContent = '';
    });

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files && fileInput.files[0];
      if (!file) return alert('Choose an image file first.');
      uploadBtn.disabled = true;
      uploadMsg.textContent = 'Uploading...';
      uploadProgress.style.width = '0%';

      try {
        const cloudRes = await uploadToCloudinary(file, (pct) => {
          uploadProgress.style.width = pct + '%';
        });

        const imageUrl = cloudRes.secure_url || cloudRes.url;
        // write a Firestore doc in gallery
        await addDoc(collection(db, GALLERY_PATH), {
          imageUrl,
          caption: fileCaption.value.trim() || '',
          order: Number(fileOrder.value || 0),
          createdAt: serverTimestamp()
        });

        uploadMsg.textContent = 'Uploaded and saved.';
        resetUpload.click();
      } catch (err) {
        console.error(err);
        alert('Upload failed: ' + (err.message || err));
        uploadMsg.textContent = 'Upload failed.';
      } finally {
        uploadBtn.disabled = false;
      }
    });

    /* ---------------- Start listeners after login ---------------- */
    let supportUnsub = null, qaUnsub = null, fixturesUnsub = null, galleryUnsub = null;

    function startListeners(){
      // Support wall
      if (supportUnsub) supportUnsub();
      supportUnsub = onSnapshot(collection(db, SUPPORT_PATH), snap => {
        const items = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        renderSupport(items);
      });

      // Questions
      if (qaUnsub) qaUnsub();
      qaUnsub = onSnapshot(collection(db, QUESTIONS_PATH), snap => {
        qaItems = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        renderQuestions();
      });

      // Fixtures (simple list)
      if (fixturesUnsub) fixturesUnsub();
      fixturesUnsub = onSnapshot(collection(db, FIXTURES_PATH), snap => {
        const docs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        renderFixturesList(docs);
      });

      // Gallery
      if (galleryUnsub) galleryUnsub();
      // order by order asc, createdAt asc
      const q = query(collection(db, GALLERY_PATH), orderBy('order','asc'), orderBy('createdAt','asc'));
      galleryUnsub = onSnapshot(q, snap => {
        const items = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        renderGallery(items);
      }, err => {
        console.error('Gallery listener failed', err);
        galleryList.innerHTML = '<p class="text-red-600">Could not load gallery.</p>';
      });
    }

    // Filters (Q&A)
    document.querySelectorAll('.qa-filter').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        document.querySelectorAll('.qa-filter').forEach(b => b.classList.remove('bg-rose-600','text-white'));
        btn.classList.add('bg-rose-600','text-white');
        qaFilter = btn.dataset.filter;
        renderQuestions();
      });
    });

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = {
      support:  document.getElementById('tab-support'),
      qa:       document.getElementById('tab-qa'),
      fixtures: document.getElementById('tab-fixtures'),
      media:    document.getElementById('tab-media')
    };
    tabs.forEach(btn => {
      btn.addEventListener('click', ()=> {
        tabs.forEach(b => b.classList.remove('bg-rose-600','text-white'));
        tabs.forEach(b => b.classList.add('bg-gray-200','text-gray-900'));
        btn.classList.add('bg-rose-600','text-white');
        Object.values(panels).forEach(p => p.classList.add('hidden'));
        panels[btn.dataset.tab].classList.remove('hidden');
      });
    });

    // Default active tab
    document.querySelector('[data-tab="support"]').click();
  </script>
</body>
</html>
