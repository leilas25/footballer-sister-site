<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex, nofollow" />
  <style>
    .fade-in { animation: fade .25s ease-out; }
    @keyframes fade { from {opacity:0; transform:translateY(4px)} to {opacity:1; transform:none} }
  </style>
</head>

<body class="bg-pink-50 text-black font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="fixed top-0 w-full flex justify-between items-center px-6 py-4 bg-pink-100 shadow z-50">
    <h1 class="text-xl font-bold uppercase text-rose-600">Admin • The Footballer’s Sister</h1>
    <nav class="space-x-6">
      <a href="index.html" class="hover:underline text-rose-600">Home</a>
    </nav>
  </header>

  <!-- LOGIN -->
  <main id="loginSection" class="flex-grow pt-32 px-6 pb-20">
    <div class="max-w-sm mx-auto bg-white rounded-xl shadow p-6 fade-in">
      <h2 class="text-2xl font-bold text-rose-700 mb-2">Admin Login</h2>
      <p class="text-sm text-gray-600 mb-4">Sign in with your admin email & password.</p>

      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" required placeholder="Email"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <input id="password" type="password" required placeholder="Password"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <button class="w-full bg-rose-600 text-white px-6 py-3 rounded-full hover:bg-rose-700 font-semibold">
          Log in
        </button>
      </form>

      <p id="loginError" class="text-red-600 text-sm mt-3 hidden"></p>
    </div>
  </main>

  <!-- NO ACCESS -->
  <section id="noAccess" class="hidden flex-grow pt-32 px-6 pb-20 text-center">
    <h2 class="text-2xl font-bold text-rose-700 mb-2">No Access</h2>
    <p class="text-gray-700">This account is not authorized to use the admin panel.</p>
    <button id="logoutNoAccess" class="mt-6 bg-gray-200 text-gray-900 px-4 py-2 rounded-full hover:bg-gray-300">
      Log out
    </button>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="adminPanel" class="hidden flex-grow pt-32 px-6 pb-20 max-w-5xl mx-auto fade-in">
    <div class="flex items-center justify-between mb-6">
      <div class="flex flex-wrap gap-3">
        <button data-tab="support" class="tab-btn bg-rose-600 text-white px-4 py-2 rounded-full">Support Wall</button>
        <button data-tab="qa" class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Q&A</button>
      </div>
      <button id="logoutBtn" class="bg-rose-600 text-white px-4 py-2 rounded-full hover:bg-rose-700">Log out</button>
    </div>

    <!-- Support Wall -->
    <div id="tab-support">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Support Wall – Moderate</h2>
      <div id="supportList" class="space-y-3">
        <p class="text-gray-500">Loading messages…</p>
      </div>
    </div>

    <!-- Q&A -->
    <div id="tab-qa" class="hidden">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Q&A – Answer & Moderate</h2>
      <div id="qaList" class="space-y-3">
        <p class="text-gray-500">Loading questions…</p>
      </div>
    </div>
  </section>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; <span id="year"></span> The Footballer’s Sister. All rights reserved.</p>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- FIREBASE ADMIN (Email/Password; multi-path merge; answer saving) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp,
      query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ✅ Your admin UID (only this user can moderate) */
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";

    /* ✅ Your Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db",
    };

    /* Init */
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    /* Candidate paths (covers current + legacy) */
    const APP_IDS = ["football-site-c3aa9", "default-app-id"];
    const PATHS = (type, appId) => [
      `/artifacts/${appId}/public/data/${type}`,
      `/${type}`
    ];

    /* UI refs */
    const loginSection = document.getElementById('loginSection');
    const adminPanel   = document.getElementById('adminPanel');
    const noAccess     = document.getElementById('noAccess');
    const loginForm    = document.getElementById('loginForm');
    const loginError   = document.getElementById('loginError');
    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutNo     = document.getElementById('logoutNoAccess');
    const supportList  = document.getElementById('supportList');
    const qaList       = document.getElementById('qaList');

    /* Helpers */
    const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    function setView(view) {
      loginSection.classList.toggle('hidden', view !== 'login');
      adminPanel.classList.toggle('hidden', view !== 'admin');
      noAccess.classList.toggle('hidden', view !== 'noaccess');
    }

    /* Auth state → gate by UID */
    onAuthStateChanged(auth, (user) => {
      if (!user) return setView('login');
      if (user.uid === ADMIN_UID) {
        setView('admin');
        startListeners();
      } else {
        setView('noaccess');
      }
    });

    /* Login form */
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');
      try {
        const email = (document.getElementById('email').value || '').trim();
        const password = document.getElementById('password').value;
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = err.message || "Login failed.";
        loginError.classList.remove('hidden');
      }
    });

    /* Logout */
    logoutBtn?.addEventListener('click', () => signOut(auth));
    logoutNo?.addEventListener('click', () => signOut(auth));

    /* ---------- Rendering (merge & show) ---------- */
    function renderSupport(items) {
      // de-dup by path+id, newest first
      const map = new Map();
      items.forEach(x => map.set(`${x._path}::${x.id}`, x));
      const data = [...map.values()].sort((a,b) => (b.data.timestamp?.seconds ?? 0) - (a.data.timestamp?.seconds ?? 0));

      supportList.innerHTML = '';
      if (!data.length) return supportList.innerHTML = '<p class="text-gray-500">No support messages yet.</p>';

      data.forEach(({ id, data, _path }) => {
        const dateText = data.timestamp?.seconds ? new Date(data.timestamp.seconds*1000).toLocaleString() : 'Just now';
        const handle   = data.userId ? `@user_${data.userId.slice(0,8)}` : '@anonymous';

        const card = document.createElement('div');
        card.className = "bg-white border rounded-2xl p-4 shadow";
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-full bg-pink-100"></div>
            <div class="flex-1">
              <div class="flex items-center gap-2 text-sm">
                <strong class="text-gray-900">${esc(data.name || 'Anonymous')}</strong>
                <span class="text-gray-400">${handle}</span>
                <span class="text-gray-400">· ${dateText}</span>
              </div>
              <p class="mt-1 text-gray-700 break-words">${esc(data.message || '')}</p>
              <div class="mt-2">
                <button class="del bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
              </div>
              <p class="text-[10px] text-gray-400 mt-1">${esc(_path)}</p>
            </div>
          </div>
        `;
        card.querySelector('.del').onclick = async () => {
          if (confirm('Delete this message?')) {
            await deleteDoc(doc(db, _path, id));
          }
        };
        supportList.appendChild(card);
      });
    }

    function renderQuestions(items) {
      const map = new Map();
      items.forEach(x => map.set(`${x._path}::${x.id}`, x));
      const data = [...map.values()].sort((a,b) => (b.data.timestamp?.seconds ?? 0) - (a.data.timestamp?.seconds ?? 0));

      qaList.innerHTML = '';
      if (!data.length) return qaList.innerHTML = '<p class="text-gray-500">No questions yet.</p>';

      data.forEach(({ id, data, _path }) => {
        const dateText = data.timestamp?.seconds ? new Date(data.timestamp.seconds*1000).toLocaleString() : 'Just now';
        const handle   = data.userId ? `@user_${data.userId.slice(0,8)}` : '@anonymous';

        const card = document.createElement('div');
        card.className = "bg-white border rounded-2xl p-4 shadow";
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-full bg-pink-100"></div>
            <div class="flex-1">
              <div class="flex items-center gap-2 text-sm">
                <strong class="text-gray-900">${esc(data.name || 'Anonymous')}</strong>
                <span class="text-gray-400">${handle}</span>
                <span class="text-gray-400">· ${dateText}</span>
              </div>
              <p class="mt-1 text-gray-800">${esc(data.question || '')}</p>

              ${data.answer
                ? `<div class="mt-3 bg-rose-50 border border-rose-200 rounded p-3 text-rose-700">
                     <strong>Answer:</strong> ${esc(data.answer)}
                   </div>
                   <div class="mt-2">
                     <button class="delete bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
                   </div>`
                : `<div class="mt-3">
                     <textarea class="ans border w-full p-2 rounded" rows="2" placeholder="Type your answer..."></textarea>
                     <div class="flex gap-2 mt-2">
                       <button class="save bg-rose-600 text-white px-3 py-1 rounded hover:bg-rose-700">Save</button>
                       <button class="delete bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
                     </div>
                   </div>`
              }
              <p class="text-[10px] text-gray-400 mt-1">${esc(_path)}</p>
            </div>
          </div>
        `;

        // Save answer back to the SAME path
        const saveBtn = card.querySelector('.save');
        if (saveBtn) {
          saveBtn.onclick = async () => {
            const answerEl = card.querySelector('.ans');
            const answer = (answerEl?.value || '').trim();
            if (!answer) return alert('Please write an answer before saving.');
            await updateDoc(doc(db, _path, id), {
              answer,
              answeredAt: serverTimestamp()
            });
          };
        }

        // Delete question at SAME path
        card.querySelectorAll('.delete').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Delete this question?')) {
              await deleteDoc(doc(db, _path, id));
            }
          };
        });

        qaList.appendChild(card);
      });
    }

    /* ---------- Subscriptions (listen to all paths and merge) ---------- */
    function subscribeMerged(type, renderFn) {
      const collected = [];
      APP_IDS.forEach(appId => {
        PATHS(type, appId).forEach(path => {
          try {
            const qRef = query(collection(db, path), orderBy('timestamp','desc'));
            onSnapshot(qRef, snap => {
              // Remove previous entries from this path
              for (let i = collected.length - 1; i >= 0; i--) {
                if (collected[i]._path === path) collected.splice(i, 1);
              }
              // Add latest entries
              snap.forEach(d => collected.push({ id: d.id, data: d.data(), _path: path }));
              renderFn(collected.slice());
            });
            console.log("[Admin] Listening:", path);
          } catch (e) {
            console.warn("[Admin] Failed to listen:", path, e);
          }
        });
      });
    }

    function startListeners() {
      subscribeMerged('supportMessages', renderSupport);
      subscribeMerged('questions',       renderQuestions);
    }

    /* Tabs */
    const tabs = document.querySelectorAll('.tab-btn');
    const tabPanels = {
      support: document.getElementById('tab-support'),
      qa:      document.getElementById('tab-qa')
    };
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => { b.classList.remove('bg-rose-600','text-white'); b.classList.add('bg-gray-200','text-gray-900'); });
      btn.classList.add('bg-rose-600','text-white');
      Object.values(tabPanels).forEach(p => p.classList.add('hidden'));
      tabPanels[btn.dataset.tab].classList.remove('hidden');
    }));
  </script>
</body>
</html>
