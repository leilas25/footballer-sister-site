<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADMIN • The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .btn { padding:.6rem 1rem; border-radius:9999px; font-weight:600; }
    .small-muted { font-size:.95rem; color:#7a7a7a; }
    .hidden-el { display:none !important; }
    .muted { color:#6b7280; }
    .response-box { width:100%; min-height:70px; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
    .error-box { background:#fff1f2; border:1px solid #fecaca; padding:.75rem; border-radius:8px; color:#991b1b; }
    .collab-row { display:flex; gap:12px; align-items:center; margin-top:12px; }
    .collab-thumb { width:88px; height:66px; object-fit:cover; border-radius:8px; border:1px solid #f3d3e2; }
    .collab-item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid #f3d3e2; background:#fff; }
    .pill { padding:.45rem .85rem; border-radius:999px; background:#fff; border:1px solid #fde7ef; color:#be185d; font-weight:700; }
    .give-card { display:flex; gap:12px; align-items:flex-start; padding:12px; border-radius:12px; border:1px solid #f3d3e2; background:#fff; }
    .give-thumb { width:120px; height:88px; object-fit:cover; border-radius:8px; border:1px solid #f3d3e2; }
    .status-pill { padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.85rem; }
    .status-ongoing { background: linear-gradient(90deg,#fef3f6,#fff0f6); color:#be185d; border:1px solid #fbddec; }
    .status-past { background: linear-gradient(90deg,#f3f4f6,#eef2ff); color:#374151; border:1px solid #e6e6ff; }
    .status-winner { background: linear-gradient(90deg,#eefbe7,#e6ffef); color:#166534; border:1px solid #b7f0c1; }
    footer .footer-badge {
      display:inline-block;
      background: linear-gradient(90deg,#be185d,#f472b6);
      color:white;
      padding:.45rem .85rem;
      border-radius:999px;
      font-weight:700;
    }
    /* Fixtures admin specific */
    .fixture-row { display:flex; gap:12px; align-items:center; padding:8px; border-radius:8px; border:1px solid #f3d3e2; background:#fff;}
    .fixture-thumb { width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid #f3d3e2; }

    /* quick-pick preview modal styles (admin only) */
    .qp-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .qp-modal { background:#fff; border-radius:12px; padding:16px; width:820px; max-width:calc(100% - 32px); box-shadow:0 20px 50px rgba(0,0,0,0.35); }
    .qp-grid { display:flex; gap:12px; align-items:flex-start; }
    .qp-thumb { width:320px; height:320px; object-fit:cover; border-radius:8px; border:1px solid #f3d3e2; background:#f9fafb; }
    .qp-meta { flex:1; }
    .qp-actions { display:flex; gap:8px; margin-top:12px; }
    .muted-sm { color:#6b7280; font-size:.95rem; }
  </style>
</head>
<body class="bg-pink-50 font-sans text-black">

  <header class="bg-pink-100 sticky top-0 z-40 shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold uppercase text-rose-600">ADMIN • THE FOOTBALLER’S SISTER</h1>
      <a href="index.html" class="text-rose-600 hover:underline">Home</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- LOGIN -->
    <section id="loginSection" class="card mx-auto max-w-md">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Admin sign-in</h2>
      <p class="small-muted mb-4">Enter the admin email & password. No admin content will be shown until the correct admin signs in.</p>

      <form id="loginForm" class="grid gap-3">
        <input id="email" type="email" placeholder="Admin email" autocomplete="username" required class="p-3 rounded border" />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" required class="p-3 rounded border" />
        <div class="flex gap-3">
          <button id="signInBtn" type="submit" class="btn bg-rose-600 text-white">Sign in</button>
          <button id="cancelBtn" type="button" class="btn bg-white border" onclick="email.value='';password.value='';">Clear</button>
        </div>
      </form>

      <!-- debug area: shows signed-in UID after login -->
      <p id="loginMessage" class="mt-3 small-muted"></p>
    </section>

    <!-- ADMIN UI -->
    <section id="adminUI" class="hidden-el" aria-hidden="true">
      <div class="flex gap-3 items-center mb-6">
        <button id="navSupport" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Support Wall</button>
        <button id="navQA" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Q&A</button>
        <button id="navFixtures" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Fixtures</button>
        <button id="navMedia" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Media / Gallery</button>
        <button id="navWinners" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Winners</button>
        <button id="navGiveaways" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Giveaways</button>

        <div class="ml-auto text-sm small-muted">
          Signed in as <span id="adminEmailDisplay"></span>
          <button id="signOutBtn" class="btn bg-rose-600 text-white ml-4">Log out</button>
        </div>
      </div>

      <div id="panes" class="space-y-6">

        <!-- Support Wall pane -->
        <div id="paneSupport" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Support Wall (admin)</h3>
          <p class="small-muted mb-3">All messages from the Support Wall are listed below. You can delete any message.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshSupportBtn" class="btn bg-white border">Refresh messages</button>
            <div id="supportStatus" class="text-sm muted"></div>
          </div>
          <div id="supportError" class="error-box hidden-el"></div>
          <div id="supportList" class="space-y-3">No messages yet.</div>
        </div>

        <!-- Q&A pane -->
        <div id="paneQA" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Q&A (admin)</h3>
          <p class="small-muted mb-3">Respond to user questions or delete any you don't want on the site.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshQABtn" class="btn bg-white border">Refresh questions</button>
            <div id="qaStatus" class="text-sm muted"></div>
          </div>
          <div id="qaError" class="error-box hidden-el"></div>
          <div id="qaList" class="space-y-4"></div>
        </div>

        <!-- Media / Gallery pane -->
        <div id="paneMedia" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Media / Gallery (admin)</h3>
          <p class="small-muted mb-3">Add images to the collabs carousel on the BTS page. Each item stores a caption and Cloudinary info.</p>

          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div class="md:col-span-2">
              <input id="collabFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>
            <div>
              <input id="collabCaption" placeholder="Caption (e.g. Elijah x Puma King)" class="p-2 rounded border w-full" />
            </div>
          </div>

          <div class="mt-4">
            <button id="uploadCollabBtn" class="btn bg-rose-600 text-white">Upload to Cloudinary & Save</button>
            <span id="mediaStatus" class="small-muted ml-4"></span>
          </div>

          <div id="mediaError" class="error-box hidden-el mt-4"></div>

          <div id="collabsList" class="mt-6 space-y-3">
            <div class="text-gray-500">Loading collabs…</div>
          </div>
        </div>

        <!-- Giveaways admin pane -->
        <div id="paneGiveaways" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Giveaways (admin)</h3>
          <p class="small-muted mb-3">Create, edit and manage giveaways. Changes will appear on the public giveaways page immediately.</p>

          <!-- Form: create / edit -->
          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div class="md:col-span-2">
              <input id="giveTitle" placeholder="Giveaway title" class="p-2 rounded border w-full" />
            </div>
            <div>
              <select id="giveStatusSelect" class="p-2 rounded border w-full">
                <option value="ongoing">Ongoing</option>
                <option value="past">Past</option>
                <option value="winner">Winners</option>
              </select>
            </div>

            <div class="md:col-span-3">
              <textarea id="giveCaption" placeholder="Caption / instructions" class="p-2 rounded border w-full" rows="3"></textarea>
            </div>

            <div>
              <input id="giveImageFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>
            <div>
              <input id="giveEndsAt" type="datetime-local" class="p-2 rounded border w-full" />
            </div>
            <div>
              <input id="giveLink" placeholder="External entry link (optional)" class="p-2 rounded border w-full" />
            </div>
          </div>

          <div class="mt-4 flex gap-3 items-center">
            <button id="createGiveBtn" class="btn bg-rose-600 text-white">Create Giveaway</button>
            <button id="updateGiveBtn" class="btn bg-white border hidden-el">Save changes</button>
            <button id="cancelEditGiveBtn" class="btn bg-white border hidden-el">Cancel edit</button>
            <div id="giveStatusMsg" class="small-muted ml-4"></div>
          </div>

          <div id="giveError" class="error-box hidden-el mt-4"></div>

          <h4 class="mt-6 font-semibold">Existing giveaways</h4>
          <div id="giveawaysList" class="mt-4 space-y-3">
            <div class="text-gray-500">Loading giveaways…</div>
          </div>
        </div>

        <!-- Winners admin pane: form + list -->
        <div id="paneWinners" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Winners (admin)</h3>
          <p class="small-muted mb-3">Add winners (photo, name, handle, prize). These appear on the public Winners page in a 3-column grid.</p>

          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div>
              <input id="winName" placeholder="Winner name" class="p-2 rounded border w-full" />
            </div>
            <div>
              <input id="winHandle" placeholder="@instagram_handle (optional)" class="p-2 rounded border w-full" />
            </div>
            <div>
              <input id="winPrize" placeholder="Prize (e.g. Socks)" class="p-2 rounded border w-full" />
            </div>

            <div class="md:col-span-2">
              <input id="winImageFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>
            <div>
              <button id="createWinBtn" class="btn bg-rose-600 text-white">Add Winner</button>
            </div>
          </div>

          <div id="winStatus" class="small-muted mt-3"></div>
          <div id="winError" class="error-box hidden-el mt-3"></div>

          <h4 class="mt-6 font-semibold">Existing winners</h4>
          <div id="winnersList" class="mt-4 space-y-3">
            <div class="text-gray-500">Loading winners…</div>
          </div>
        </div>

        <!-- FIXTURES admin pane: form + list (UPDATED with scores) -->
        <div id="paneFixtures" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Fixtures (admin)</h3>
          <p class="small-muted mb-3">Create fixtures grouped by age group (U19, U14, Senior). Upload team logos and add a watch/stream link. You can also add scores here.</p>

          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div>
              <label class="small-muted block mb-1">Age group</label>
              <select id="fxAgeGroup" class="p-2 rounded border w-full">
                <option value="Senior">Senior</option>
                <option value="U19">U19</option>
                <option value="U14">U14</option>
              </select>
            </div>

            <div>
              <label class="small-muted block mb-1">Kickoff (local)</label>
              <input id="fxKickoff" type="datetime-local" class="p-2 rounded border w-full" />
            </div>

            <div>
              <label class="small-muted block mb-1">Status</label>
              <select id="fxStatus" class="p-2 rounded border w-full">
                <option value="scheduled">Scheduled</option>
                <option value="live">Live</option>
                <option value="finished">Finished</option>
              </select>
            </div>

            <div>
              <label class="small-muted block mb-1">Team A name</label>
              <input id="fxTeamA" placeholder="Home team name" class="p-2 rounded border w-full" />
            </div>

            <div>
              <label class="small-muted block mb-1">Team B name</label>
              <input id="fxTeamB" placeholder="Away team name" class="p-2 rounded border w-full" />
            </div>

            <div>
              <label class="small-muted block mb-1">Venue</label>
              <input id="fxVenue" placeholder="Venue (optional)" class="p-2 rounded border w-full" />
            </div>

            <div>
              <label class="small-muted block mb-1">Team A logo</label>
              <input id="fxTeamAFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>

            <div>
              <label class="small-muted block mb-1">Team B logo</label>
              <input id="fxTeamBFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>

            <div>
              <label class="small-muted block mb-1">Watch / stream link</label>
              <input id="fxStream" placeholder="https://..." class="p-2 rounded border w-full" />
            </div>

            <div class="md:col-span-3">
              <label class="small-muted block mb-1">Broadcast / caption (optional)</label>
              <input id="fxBroadcast" placeholder="Catch it Live on SS Football …" class="p-2 rounded border w-full" />
            </div>

            <!-- NEW score inputs -->
            <div>
              <label class="small-muted block mb-1">Score — Team A</label>
              <input id="fxScoreA" type="number" min="0" placeholder="e.g. 2" class="p-2 rounded border w-full" />
            </div>

            <div>
              <label class="small-muted block mb-1">Score — Team B</label>
              <input id="fxScoreB" type="number" min="0" placeholder="e.g. 1" class="p-2 rounded border w-full" />
            </div>

            <div class="md:col-span-3 flex gap-3 items-center mt-2">
              <button id="createFxBtn" class="btn bg-rose-600 text-white">Create fixture</button>
              <button id="updateFxBtn" class="btn bg-white border hidden-el">Save changes</button>
              <button id="cancelFxEditBtn" class="btn bg-white border hidden-el">Cancel</button>
              <div id="fxStatusMsg" class="small-muted ml-4"></div>
            </div>
          </div>

          <div id="fxError" class="error-box hidden-el mt-4"></div>

          <h4 class="mt-6 font-semibold">Existing fixtures</h4>
          <div id="fixturesList" class="mt-4 space-y-3">
            <div class="text-gray-500">Loading fixtures…</div>
          </div>
        </div>

        <div id="paneGiveawaysBackup" class="card hidden-el"><h3 class="text-lg font-bold">Giveaways Backup (unchanged)</h3></div>

      </div>
    </section>
  </main>

  <footer class="bg-pink-900 text-white text-center py-6">
    <div class="max-w-6xl mx-auto">
      <small><span class="footer-badge">© <span id="year"></span> The Footballer’s Sister</span></small>
    </div>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Firebase + Admin JS (module) -->
  <script type="module">
    /**************************************************************************
     * Admin JS - with Cloudinary unsigned upload for collabs + giveaways + winners
     * Fixtures admin pane updated to include score editing (scoreHome, scoreAway)
     * Added Quick Pick Random Winner functionality (admin-only) with preview modal.
     **************************************************************************/

    // ---------- CONFIG ----------
    // Accept admin by UID OR by email (case-insensitive)
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";
    const ADMIN_EMAIL = "leilasono1@gmail.com";

    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db"
    };
    const APP_ID = firebaseConfig.appId;

    // Cloudinary (your values)
    const CLOUD_NAME = 'dk1df1qmi';                  // <-- your cloud name
    const UPLOAD_PRESET = 'unsigned_bts_preset';     // <-- your unsigned preset

    // collection paths (these must match what your public pages read)
    const GIVEAWAYS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/giveaways`;
    const WINNERS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/winners`;
    const COLLABS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/collabs`;
    const FIXTURES_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/fixtures`;
    // NEW: top-level entries collection (where validated entries live by default)
    const ENTRIES_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/giveawayEntries`;

    // Candidate bases to try (used by other panes)
    const CANDIDATE_BASES = [
      `/artifacts/${APP_ID}/public/data`,
      `/artifacts/${APP_ID}/public`,
      `/artifacts/${APP_ID}`,
      `/public/data`,
      '' // top-level
    ];

    // ---------- IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, where, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- DOM ----------
    const loginSection = document.getElementById('loginSection');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    const adminUI = document.getElementById('adminUI');
    const adminEmailDisplay = document.getElementById('adminEmailDisplay');
    const signOutBtn = document.getElementById('signOutBtn');

    const navSupport = document.getElementById('navSupport');
    const navQA = document.getElementById('navQA');
    const navFixtures = document.getElementById('navFixtures');
    const navMedia = document.getElementById('navMedia');
    const navGiveaways = document.getElementById('navGiveaways');
    const navWinners = document.getElementById('navWinners');

    const paneSupport = document.getElementById('paneSupport');
    const paneQA = document.getElementById('paneQA');
    const paneMedia = document.getElementById('paneMedia');
    const paneGiveaways = document.getElementById('paneGiveaways');
    const paneWinners = document.getElementById('paneWinners');
    const paneFixtures = document.getElementById('paneFixtures');

    const refreshSupportBtn = document.getElementById('refreshSupportBtn');
    const supportList = document.getElementById('supportList');
    const supportStatus = document.getElementById('supportStatus');
    const supportError = document.getElementById('supportError');

    const refreshQABtn = document.getElementById('refreshQABtn');
    const qaList = document.getElementById('qaList');
    const qaStatus = document.getElementById('qaStatus');
    const qaError = document.getElementById('qaError');

    // media elements
    const collabFile = document.getElementById('collabFile');
    const collabCaption = document.getElementById('collabCaption');
    const uploadCollabBtn = document.getElementById('uploadCollabBtn');
    const collabsList = document.getElementById('collabsList');
    const mediaStatus = document.getElementById('mediaStatus');
    const mediaError = document.getElementById('mediaError');

    // giveaways elements
    const giveTitle = document.getElementById('giveTitle');
    const giveCaption = document.getElementById('giveCaption');
    const giveImageFile = document.getElementById('giveImageFile');
    const giveEndsAt = document.getElementById('giveEndsAt');
    const giveLink = document.getElementById('giveLink');
    const giveStatusSelect = document.getElementById('giveStatusSelect');
    const createGiveBtn = document.getElementById('createGiveBtn');
    const updateGiveBtn = document.getElementById('updateGiveBtn');
    const cancelEditGiveBtn = document.getElementById('cancelEditGiveBtn');
    const giveStatusMsg = document.getElementById('giveStatusMsg');
    const giveError = document.getElementById('giveError');
    const giveawaysList = document.getElementById('giveawaysList');

    // winners elements
    const winName = document.getElementById('winName');
    const winHandle = document.getElementById('winHandle');
    const winPrize = document.getElementById('winPrize');
    const winImageFile = document.getElementById('winImageFile');
    const createWinBtn = document.getElementById('createWinBtn');
    const winnersList = document.getElementById('winnersList');
    const winStatus = document.getElementById('winStatus');
    const winError = document.getElementById('winError');

    // fixtures elements (NEW)
    const fxAgeGroup = document.getElementById('fxAgeGroup');
    const fxKickoff = document.getElementById('fxKickoff');
    const fxStatus = document.getElementById('fxStatus');
    const fxTeamA = document.getElementById('fxTeamA');
    const fxTeamB = document.getElementById('fxTeamB');
    const fxVenue = document.getElementById('fxVenue');
    const fxTeamAFile = document.getElementById('fxTeamAFile');
    const fxTeamBFile = document.getElementById('fxTeamBFile');
    const fxStream = document.getElementById('fxStream');
    const fxBroadcast = document.getElementById('fxBroadcast');
    const fxScoreA = document.getElementById('fxScoreA'); // new
    const fxScoreB = document.getElementById('fxScoreB'); // new
    const createFxBtn = document.getElementById('createFxBtn');
    const updateFxBtn = document.getElementById('updateFxBtn');
    const cancelFxEditBtn = document.getElementById('cancelFxEditBtn');
    const fxStatusMsg = document.getElementById('fxStatusMsg');
    const fxError = document.getElementById('fxError');
    const fixturesList = document.getElementById('fixturesList');

    let currentEditId = null;
    let currentEditFxId = null;

    function hideAllPanes() {
      [paneSupport, paneQA, paneMedia, paneGiveaways, paneWinners, paneFixtures].forEach(p => p.classList.add('hidden-el'));
    }

    // ---------- AUTH ----------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMessage.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      } catch (err) {
        console.error('Sign-in error', err);
        loginMessage.textContent = 'Sign-in failed: ' + (err.message || '');
      }
    });

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        loginSection.classList.remove('hidden-el');
        adminUI.classList.add('hidden-el');
        hideAllPanes();
        return;
      }

      // Show signed-in UID + email for debugging
      loginMessage.textContent = 'Signed in UID: ' + (user.uid || '(none)') + ' — Email: ' + (user.email || '(no-email)');

      // Allow admin if UID matches OR email matches ADMIN_EMAIL (case-insensitive)
      const isAdminByUid = (user.uid === ADMIN_UID);
      const isAdminByEmail = (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());

      if (!isAdminByUid && !isAdminByEmail) {
        // If not the expected admin, sign out and show message
        signOut(auth).catch(()=>{});
        loginMessage.textContent = `Signed in UID ${user.uid} / Email ${user.email || '(none)'} is not the configured admin. Signed out.`;
        return;
      }

      // If we reach here the user is allowed admin access
      loginSection.classList.add('hidden-el');
      adminUI.classList.remove('hidden-el');
      adminEmailDisplay.textContent = user.email || user.uid;
      // default to support pane
      showSupportPane();
    });

    signOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); loginMessage.textContent = 'Signed out.'; } catch(e){ console.error(e); }
    });

    // NAV handlers
    navSupport.addEventListener('click', showSupportPane);
    navQA.addEventListener('click', showQAPane);
    navMedia.addEventListener('click', showMediaPane);
    navGiveaways.addEventListener('click', showGiveawaysPane);
    navWinners.addEventListener('click', showWinnersPane);
    navFixtures.addEventListener('click', showFixturesPane);

    function showSupportPane(){ hideAllPanes(); paneSupport.classList.remove('hidden-el'); loadSupport(); }
    function showQAPane(){ hideAllPanes(); paneQA.classList.remove('hidden-el'); loadQA(); }
    function showMediaPane(){ hideAllPanes(); paneMedia.classList.remove('hidden-el'); loadCollabs(); }
    function showGiveawaysPane(){ hideAllPanes(); paneGiveaways.classList.remove('hidden-el'); loadGiveaways(); }
    function showWinnersPane(){ hideAllPanes(); paneWinners.classList.remove('hidden-el'); loadWinnersAdmin(); }
    function showFixturesPane(){ hideAllPanes(); paneFixtures.classList.remove('hidden-el'); loadFixturesAdmin(); }

    refreshSupportBtn.addEventListener('click', loadSupport);
    refreshQABtn.addEventListener('click', loadQA);

    // ---------- UTIL helpers ----------
    function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function tryReadCollectionAtBase(base, collectionName) {
      const path = base ? `${base}/${collectionName}` : collectionName;
      try {
        const q = query(collection(db, path));
        const snap = await getDocs(q);
        return { success: true, docs: snap.docs.map(d => ({ id: d.id, data: d.data() })), base, path };
      } catch (err) {
        return { success: false, error: err, base, path };
      }
    }

    async function autoDetectAndRead(collectionName) {
      let firstError = null;
      for (const base of CANDIDATE_BASES) {
        const res = await tryReadCollectionAtBase(base, collectionName);
        if (res.success) return res;
        if (!firstError) firstError = res;
        console.warn('Read error for', res.path, res.error && res.error.code ? res.error.code : res.error);
      }
      return firstError;
    }

    // ---------- SUPPORT: load, render, delete ----------
    async function loadSupport() {
      supportStatus.textContent = 'Loading...';
      supportError.classList.add('hidden-el');
      supportList.innerHTML = '';
      const res = await autoDetectAndRead('supportMessages');
      if (res && res.success) {
        supportStatus.textContent = `Loaded from: ${res.base || 'top-level'}`;
        const docs = res.docs;
        if (!docs.length) {
          supportList.innerHTML = '<div class="text-gray-500">No messages yet.</div>';
          return;
        }
        docs.sort((a,b) => {
          const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
          const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
          return tb - ta;
        });
        renderSupportDocs(docs, res.path);
      } else {
        console.error('Support read error:', res);
        supportStatus.textContent = 'Load failed';
        supportError.classList.remove('hidden-el');
        supportError.innerHTML = `<strong>Error reading supportMessages</strong><br> Path tried: <code>${res.path}</code><br> Error: ${escapeHtml(res.error && (res.error.message||res.error.code) || String(res.error))}<br><br>Check Firestore rules (allow read) or that the docs exist at this path.`;
      }
    }

    function renderSupportDocs(docs, basePath) {
      supportList.innerHTML = '';
      docs.forEach(it => {
        const d = it.data || {};
        const timeLabel = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : 'Unknown';
        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded shadow flex items-start gap-3';
        el.innerHTML = `
          <div style="width:48px;flex-shrink:0;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="#be185d"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10s-2.5-1.12-2.5-2.5S10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
          </div>
          <div style="flex:1">
            <div style="display:flex;gap:.5rem;align-items:center;">
              <div style="font-weight:700">${escapeHtml(d.name || 'Anonymous')}</div>
              <div style="color:#94a3b8;font-size:.85rem">@${(d.userId||'').substring(0,8)}</div>
              <div style="color:#94a3b8;font-size:.75rem;margin-left:.5rem;">· ${timeLabel}</div>
            </div>
            <div style="margin-top:.6rem;color:#374151;">${escapeHtml(d.message || '')}</div>
            <div style="margin-top:.6rem;color:#6b7280;font-size:.9rem;">${ d.adminResponse ? `<strong>Admin:</strong> ${escapeHtml(d.adminResponse)} <span class="muted">· ${d.respondedAt && d.respondedAt.seconds ? new Date(d.respondedAt.seconds*1000).toLocaleString() : ''}</span>` : '<span class="muted">No admin response yet.</span>' }</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem;">
            <button class="delete-support btn bg-white border" data-id="${it.id}" data-base="${basePath}">Delete</button>
          </div>
        `;
        supportList.appendChild(el);
      });

      supportList.querySelectorAll('.delete-support').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          if (!confirm('Delete message?')) return;
          try {
            const fullPath = `${basePath}/${id}`;
            await deleteDoc(doc(db, fullPath));
            loadSupport();
          } catch (err) {
            console.error('Delete failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // ---------- Q&A: load, render, respond, delete ----------
    function getQuestionText(data) {
      if (!data || typeof data !== 'object') return '';
      const keys = [ 'body','message','question','text','q','description','content','msg','questionText','question_text','questionBody','question_body','questionTxt','question_message','message_text','bodyText','body_text','contentText','content_text','ask','ask_text','userQuestion','user_question','input','questionValue' ];
      const hasKeyWithValue = (obj, key) => {
        if (!obj) return null;
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] && String(obj[key]).trim()) return String(obj[key]);
        const lower = key.toLowerCase();
        for (const k of Object.keys(obj)) {
          if (k.toLowerCase() === lower && obj[k] && String(obj[k]).trim()) return String(obj[k]);
        }
        return null;
      };
      for (const k of keys) {
        const v = hasKeyWithValue(data, k);
        if (v) return v;
      }
      for (const k of Object.keys(data)) {
        const v = data[k];
        if (typeof v === 'string' && v.trim()) return v;
      }
      for (const k of Object.keys(data)) {
        const v = data[k];
        if (v && typeof v === 'object') {
          for (const cand of keys) {
            const nested = hasKeyWithValue(v, cand);
            if (nested) return nested;
          }
          for (const nk of Object.keys(v)) {
            if (typeof v[nk] === 'string' && String(v[nk]).trim()) return v[nk];
          }
        }
      }
      const queue = [{obj:data,depth:0}];
      const seen = new Set();
      while (queue.length) {
        const {obj, depth} = queue.shift();
        if (!obj || typeof obj !== 'object' || depth > 2) continue;
        for (const key of Object.keys(obj)) {
          const val = obj[key];
          if (typeof val === 'string' && val.trim()) return val;
          if (val && typeof val === 'object' && !seen.has(val)) {
            seen.add(val);
            queue.push({obj: val, depth: depth + 1});
          }
        }
      }
      return '';
    }

    async function loadQA() {
      qaStatus.textContent = 'Loading...';
      qaError.classList.add('hidden-el');
      qaList.innerHTML = '';
      const res = await autoDetectAndRead('questions');
      if (res && res.success) {
        qaStatus.textContent = `Loaded from: ${res.base || 'top-level'}`;
        const docs = res.docs;
        if (!docs.length) { qaList.innerHTML = '<div class="text-gray-500">No questions yet.</div>'; return; }
        docs.sort((a,b) => {
          const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
          const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
          return tb - ta;
        });
        renderQADocs(docs, res.path);
      } else {
        console.error('Q&A read error:', res);
        qaStatus.textContent = 'Load failed';
        qaError.classList.remove('hidden-el');
        qaError.innerHTML = `<strong>Error reading questions</strong><br> Path tried: <code>${res.path}</code><br> Error: ${escapeHtml(res.error && (res.error.message||res.error.code) || String(res.error))}<br><br>Check Firestore rules (allow read) or that the docs exist at this path.`;
      }
    }

    function renderQADocs(docs, basePath) {
      qaList.innerHTML = '';
      docs.forEach(it => {
        const d = it.data || {};
        const timeLabel = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : 'Unknown';
        const questionText = getQuestionText(d) || '';
        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded shadow';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
            <div style="flex:1">
              <div style="font-weight:700">${escapeHtml(d.title || 'Question')}</div>
              <div style="color:#374151;margin-top:.4rem;">${ questionText ? escapeHtml(questionText) : '<span class="muted">[Question text unavailable]</span>' }</div>
              <div style="color:#94a3b8;font-size:.85rem;margin-top:.5rem;">From: ${escapeHtml(d.name || 'Anonymous')} ${ timeLabel ? '· ' + escapeHtml(timeLabel) : '' }</div>

              <div style="margin-top:.8rem;">
                <div style="font-size:.9rem;color:#6b7280;margin-bottom:.5rem;">Admin response (saved to Firestore):</div>
                <textarea class="response-box" data-id="${it.id}">${d.adminResponse ? escapeHtml(d.adminResponse) : ''}</textarea>
                <div class="mt-2 flex gap-2">
                  <button class="respond-qa btn bg-rose-600 text-white" data-id="${it.id}" data-base="${basePath}">Save Response</button>
                  <button class="delete-qa btn bg-white border" data-id="${it.id}" data-base="${basePath}">Delete question</button>
                </div>
              </div>
            </div>
          </div>
        `;
        qaList.appendChild(el);
      });

      qaList.querySelectorAll('.respond-qa').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          const textarea = qaList.querySelector(`textarea[data-id="${id}"]`);
          if (!textarea) return;
          const text = textarea.value.trim();
          if (!confirm('Save response to this question?')) return;
          try {
            const fullPath = `${basePath}/${id}`;
            await updateDoc(doc(db, fullPath), { adminResponse: text, responder: auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin', respondedAt: serverTimestamp() });
            alert('Response saved.');
            loadQA();
          } catch (err) {
            console.error('Save response failed', err);
            alert('Could not save response: ' + (err.message || err.code || err));
          }
        });
      });

      qaList.querySelectorAll('.delete-qa').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          if (!confirm('Delete question?')) return;
          try {
            const fullPath = `${basePath}/${id}`;
            await deleteDoc(doc(db, fullPath));
            loadQA();
          } catch (err) {
            console.error('Delete failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // ---------- MEDIA / COLLABS ----------
    async function loadCollabs() {
      collabsList.innerHTML = '<div class="text-gray-500">Loading collabs…</div>';
      mediaError.classList.add('hidden-el');
      mediaStatus.textContent = '';

      try {
        const collRef = collection(db, COLLABS_COLLECTION_PATH);
        onSnapshot(collRef, (snap) => {
          const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          docs.sort((a,b) => (b.uploadedAt?.seconds ?? 0) - (a.uploadedAt?.seconds ?? 0));
          renderCollabs(docs);
        }, (err) => {
          console.error('collabs onSnapshot error', err);
          collabsList.innerHTML = '<div class="text-gray-500">Unable to load collabs.</div>';
        });
      } catch (err) {
        console.error('loadCollabs failed', err);
        collabsList.innerHTML = '<div class="text-gray-500">Unable to load collabs.</div>';
        mediaError.classList.remove('hidden-el');
        mediaError.textContent = 'Could not read collabs: ' + (err.message || err.code || err);
      }
    }

    function renderCollabs(docs) {
      collabsList.innerHTML = '';
      if (!docs.length) {
        collabsList.innerHTML = '<div class="text-gray-500">No collabs yet.</div>';
        return;
      }
      docs.forEach(c => {
        const el = document.createElement('div');
        el.className = 'collab-item';
        el.innerHTML = `
          <img class="collab-thumb" src="${escapeHtml(c.imageUrl || '')}" alt="${escapeHtml(c.caption || '')}" onerror="this.onerror=null;this.src='images/opponent.png'"/>
          <div style="flex:1;">
            <div style="font-weight:700;">${escapeHtml(c.caption || '(no caption)')}</div>
            <div style="color:#6b7280;font-size:.9rem;margin-top:.35rem;">Uploaded: ${c.uploadedAt && c.uploadedAt.seconds ? new Date(c.uploadedAt.seconds*1000).toLocaleString() : 'Unknown'}</div>
            <div style="margin-top:.5rem;">
              <button class="btn bg-white border remove-collab" data-id="${escapeHtml(c.id)}">Remove</button>
            </div>
          </div>
        `;
        collabsList.appendChild(el);
      });

      collabsList.querySelectorAll('.remove-collab').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Remove this collab from the carousel?')) return;
          try {
            await deleteDoc(doc(db, `${COLLABS_COLLECTION_PATH}/${id}`));
          } catch (err) {
            console.error('Delete collab failed', err);
            alert('Could not remove collab: ' + (err.message || err.code || err));
          }
        });
      });
    }

    async function uploadToCloudinary(file) {
      if (!file) throw new Error('No file supplied');
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      try {
        const resp = await fetch(url, { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok) {
          const msg = json.error && json.error.message ? json.error.message : JSON.stringify(json);
          throw new Error(msg || 'Cloudinary upload failed');
        }
        return json; // contains secure_url, public_id, etc.
      } catch (err) {
        throw err;
      }
    }

    async function saveCollabToFirestore(metadata) {
      try {
        await addDoc(collection(db, COLLABS_COLLECTION_PATH), {
          imageUrl: metadata.imageUrl,
          publicId: metadata.publicId,
          caption: metadata.caption || '',
          uploader: metadata.uploader || (auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin'),
          uploadedAt: serverTimestamp()
        });
      } catch (err) {
        throw err;
      }
    }

    uploadCollabBtn.addEventListener('click', async (e) => {
      mediaError.classList.add('hidden-el');
      mediaStatus.textContent = '';
      const file = collabFile.files && collabFile.files[0];
      const caption = collabCaption.value.trim();

      if (!file) {
        mediaError.classList.remove('hidden-el');
        mediaError.textContent = 'Select an image file to upload.';
        return;
      }

      uploadCollabBtn.disabled = true;
      uploadCollabBtn.textContent = 'Uploading...';

      try {
        const cloudResp = await uploadToCloudinary(file);
        if (!cloudResp || !cloudResp.secure_url) throw new Error('Cloudinary did not return a secure_url');

        const metadata = {
          imageUrl: cloudResp.secure_url,
          publicId: cloudResp.public_id,
          caption,
          uploader: auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'admin'
        };
        await saveCollabToFirestore(metadata);

        mediaStatus.textContent = 'Uploaded and saved.';
        collabFile.value = '';
        collabCaption.value = '';
      } catch (err) {
        console.error('Upload/save error', err);
        mediaError.classList.remove('hidden-el');
        const msg = err && err.message ? err.message : String(err);
        mediaError.textContent = `Upload or save failed: ${msg}`;
      } finally {
        uploadCollabBtn.disabled = false;
        uploadCollabBtn.textContent = 'Upload to Cloudinary & Save';
      }
    });

    // ---------- GIVEAWAYS: load, create, edit, delete, realtime ----------
    async function loadGiveaways() {
      giveawaysList.innerHTML = '<div class="text-gray-500">Loading giveaways…</div>';
      giveError.classList.add('hidden-el');
      giveStatusMsg.textContent = '';

      try {
        const ref = collection(db, GIVEAWAYS_COLLECTION_PATH);
        onSnapshot(ref, (snap) => {
          const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          docs.sort((a,b) => (b.createdAt?.seconds ?? 0) - (a.createdAt?.seconds ?? 0));
          renderGiveawaysList(docs);
        }, (err) => {
          console.error('giveaways onSnapshot error', err);
          giveawaysList.innerHTML = '<div class="text-gray-500">Unable to load giveaways.</div>';
        });
      } catch (err) {
        console.error('loadGiveaways failed', err);
        giveawaysList.innerHTML = '<div class="text-gray-500">Unable to load giveaways.</div>';
        giveError.classList.remove('hidden-el');
        giveError.textContent = 'Could not read giveaways: ' + (err.message || err.code || err);
      }
    }

    function renderGiveawaysList(docs) {
      giveawaysList.innerHTML = '';
      if (!docs.length) {
        giveawaysList.innerHTML = '<div class="text-gray-500">No giveaways yet.</div>';
        return;
      }
      docs.forEach(g => {
        const endsAtLabel = g.endsAt ? (typeof g.endsAt === 'object' && g.endsAt.seconds ? new Date(g.endsAt.seconds*1000).toLocaleString() : new Date(g.endsAt).toLocaleString()) : '—';
        const statusClass = g.status === 'ongoing' ? 'status-ongoing' : (g.status === 'past' ? 'status-past' : 'status-winner');
        const el = document.createElement('div');
        el.className = 'give-card';
        el.innerHTML = `
          <img class="give-thumb" src="${escapeHtml(g.imageUrl || '')}" alt="${escapeHtml(g.title || '')}" onerror="this.onerror=null;this.src='images/opponent.png'"/>
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:.6rem;">
              <div style="font-weight:800;">${escapeHtml(g.title || '(no title)')}</div>
              <div class="status-pill ${statusClass}" style="margin-left:auto">${escapeHtml(g.status || 'ongoing')}</div>
            </div>
            <div style="color:#6b7280;font-size:.9rem;margin-top:.45rem;">Ends: ${endsAtLabel}</div>
            <div style="margin-top:.6rem;color:#374151;">${escapeHtml(g.caption || '')}</div>
            <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;">
              <button class="btn bg-white border edit-give" data-id="${g.id}">Edit</button>
              <button class="btn bg-white border change-status" data-id="${g.id}">Change status</button>
              <button class="btn bg-white border delete-give" data-id="${g.id}">Delete</button>
              <a class="btn bg-rose-600 text-white" href="${escapeHtml(g.link || '#')}" target="_blank" ${g.link ? '' : 'aria-hidden="true"'}>Entry link</a>
              <!-- NEW: Quick pick winner button (admin-only) -->
              <button class="btn bg-rose-500 text-white quick-pick" data-id="${g.id}" data-title="${escapeHtml(g.title||'')}" style="margin-left:6px;">Quick pick winner</button>
            </div>
          </div>
        `;
        giveawaysList.appendChild(el);
      });

      // wire actions
      giveawaysList.querySelectorAll('.edit-give').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          try {
            const q = query(collection(db, GIVEAWAYS_COLLECTION_PATH));
            const snapAll = await getDocs(q);
            const found = snapAll.docs.find(d => d.id === id);
            if (!found) throw new Error('Giveaway not found');
            const data = found.data();
            currentEditId = id;
            giveTitle.value = data.title || '';
            giveCaption.value = data.caption || '';
            giveLink.value = data.link || '';
            giveStatusSelect.value = data.status || 'ongoing';
            if (data.endsAt && data.endsAt.seconds) {
              const dt = new Date(data.endsAt.seconds*1000);
              giveEndsAt.value = dt.toISOString().slice(0,16);
            } else if (data.endsAt) {
              try { giveEndsAt.value = new Date(data.endsAt).toISOString().slice(0,16); } catch(e){ giveEndsAt.value = ''; }
            } else { giveEndsAt.value = ''; }

            createGiveBtn.classList.add('hidden-el');
            updateGiveBtn.classList.remove('hidden-el');
            cancelEditGiveBtn.classList.remove('hidden-el');
            giveStatusMsg.textContent = 'Editing giveaway — remember to Save changes.';
            window.scrollTo({top: giveawaysList.offsetTop - 20, behavior: 'smooth'});
          } catch (err) {
            console.error('Edit load failed', err);
            alert('Could not load giveaway for editing: ' + (err.message || err));
          }
        });
      });

      giveawaysList.querySelectorAll('.change-status').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          const newStatus = prompt('Enter new status (ongoing, past, winner):');
          if (!newStatus) return;
          if (!['ongoing','past','winner'].includes(newStatus)) return alert('Invalid status.');
          if (!confirm(`Change status to "${newStatus}"?`)) return;
          try {
            await updateDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${id}`), { status: newStatus });
            alert('Status updated.');
          } catch (err) {
            console.error('Status update failed', err);
            alert('Could not update status: ' + (err.message || err));
          }
        });
      });

      giveawaysList.querySelectorAll('.delete-give').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          if (!confirm('Delete this giveaway? This cannot be undone.')) return;
          try {
            await deleteDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${id}`));
            alert('Giveaway removed.');
          } catch (err) {
            console.error('Delete giveaway failed', err);
            alert('Could not delete giveaway: ' + (err.message || err));
          }
        });
      });

      // wire quick pick
      giveawaysList.querySelectorAll('.quick-pick').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          const title = ev.currentTarget.getAttribute('data-title') || '';
          await quickPickWinner(id, title);
        });
      });
    }

    // create new giveaway
    createGiveBtn.addEventListener('click', async () => {
      giveError.classList.add('hidden-el');
      giveStatusMsg.textContent = '';
      const title = (giveTitle.value || '').trim();
      const caption = (giveCaption.value || '').trim();
      const link = (giveLink.value || '').trim();
      const status = (giveStatusSelect.value || 'ongoing');
      const file = giveImageFile.files && giveImageFile.files[0];
      const endsAtVal = giveEndsAt.value ? new Date(giveEndsAt.value).toISOString() : null;

      if (!title || !caption) {
        giveError.classList.remove('hidden-el');
        giveError.textContent = 'Please add title and caption.';
        return;
      }

      createGiveBtn.disabled = true;
      createGiveBtn.textContent = 'Posting...';

      try {
        let imageUrl = '';
        let publicId = '';
        if (file) {
          const cloudResp = await uploadToCloudinary(file);
          imageUrl = cloudResp.secure_url;
          publicId = cloudResp.public_id;
        }
        await addDoc(collection(db, GIVEAWAYS_COLLECTION_PATH), {
          title, caption, link: link || '', imageUrl: imageUrl || '', publicId: publicId || '', status,
          endsAt: endsAtVal || null,
          createdAt: serverTimestamp(),
          uploader: auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'admin'
        });
        giveStatusMsg.textContent = 'Giveaway posted.';
        giveTitle.value = '';
        giveCaption.value = '';
        giveImageFile.value = '';
        giveLink.value = '';
        giveEndsAt.value = '';
      } catch (err) {
        console.error('Create giveaway failed', err);
        giveError.classList.remove('hidden-el');
        giveError.textContent = 'Create failed: ' + (err.message || err.code || err);
      } finally {
        createGiveBtn.disabled = false;
        createGiveBtn.textContent = 'Create Giveaway';
      }
    });

    // update existing giveaway
    updateGiveBtn.addEventListener('click', async () => {
      if (!currentEditId) return;
      giveError.classList.add('hidden-el');
      giveStatusMsg.textContent = '';

      const title = (giveTitle.value || '').trim();
      const caption = (giveCaption.value || '').trim();
      const link = (giveLink.value || '').trim();
      const status = (giveStatusSelect.value || 'ongoing');
      const file = giveImageFile.files && giveImageFile.files[0];
      const endsAtVal = giveEndsAt.value ? new Date(giveEndsAt.value).toISOString() : null;

      if (!title || !caption) {
        giveError.classList.remove('hidden-el');
        giveError.textContent = 'Please add title and caption.';
        return;
      }

      updateGiveBtn.disabled = true;
      updateGiveBtn.textContent = 'Saving...';

      try {
        let imageUrl = null;
        let publicId = null;
        if (file) {
          const cloudResp = await uploadToCloudinary(file);
          imageUrl = cloudResp.secure_url;
          publicId = cloudResp.public_id;
        }
        const payload = {
          title, caption, link: link || '', status,
          endsAt: endsAtVal || null,
          updatedAt: serverTimestamp()
        };
        if (imageUrl) { payload.imageUrl = imageUrl; payload.publicId = publicId; }

        await updateDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${currentEditId}`), payload);
        giveStatusMsg.textContent = 'Giveaway updated.';
        currentEditId = null;
        giveTitle.value = '';
        giveCaption.value = '';
        giveImageFile.value = '';
        giveLink.value = '';
        giveEndsAt.value = '';
        giveStatusSelect.value = 'ongoing';
        createGiveBtn.classList.remove('hidden-el');
        updateGiveBtn.classList.add('hidden-el');
        cancelEditGiveBtn.classList.add('hidden-el');
      } catch (err) {
        console.error('Update failed', err);
        giveError.classList.remove('hidden-el');
        giveError.textContent = 'Update failed: ' + (err.message || err.code || err);
      } finally {
        updateGiveBtn.disabled = false;
        updateGiveBtn.textContent = 'Save changes';
      }
    });

    cancelEditGiveBtn.addEventListener('click', () => {
      currentEditId = null;
      giveTitle.value = '';
      giveCaption.value = '';
      giveImageFile.value = '';
      giveLink.value = '';
      giveEndsAt.value = '';
      giveStatusSelect.value = 'ongoing';
      createGiveBtn.classList.remove('hidden-el');
      updateGiveBtn.classList.add('hidden-el');
      cancelEditGiveBtn.classList.add('hidden-el');
      giveStatusMsg.textContent = '';
    });

    // ---------- WINNERS admin helpers ----------
    function loadWinnersAdmin() {
      if (!winnersList) return;
      winnersList.innerHTML = '<div class="text-gray-500">Loading winners…</div>';
      try {
        const ref = collection(db, WINNERS_COLLECTION_PATH);
        onSnapshot(ref, snap => {
          const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          docs.sort((a,b) => (b.createdAt?.seconds ?? 0) - (a.createdAt?.seconds ?? 0));
          renderWinnersList(docs);
        }, err => {
          console.error('winners onSnapshot error', err);
          winnersList.innerHTML = '<div class="text-red-600">Could not load winners.</div>';
        });
      } catch(err) {
        console.error('loadWinnersAdmin failed', err);
        winnersList.innerHTML = '<div class="text-red-600">Could not load winners.</div>';
      }
    }

    function renderWinnersList(docs) {
      winnersList.innerHTML = '';
      if (!docs.length) { winnersList.innerHTML = '<div class="text-gray-500">No winners yet.</div>'; return; }
      docs.forEach(w => {
        const el = document.createElement('div');
        el.className = 'give-card';
        el.innerHTML = `
          <img class="give-thumb" src="${escapeHtml(w.imageUrl||'')}" alt="${escapeHtml(w.name||'')}" onerror="this.onerror=null;this.src='images/opponent.png'"/>
          <div style="flex:1;">
            <div style="font-weight:700;">${escapeHtml(w.name||'(no name)')}</div>
            <div style="color:#6b7280;font-size:.9rem;">${escapeHtml(w.handle||'')}</div>
            <div style="margin-top:.4rem;color:#374151;">Prize: ${escapeHtml(w.prize||'')}</div>
            <div style="margin-top:.6rem;">
              <button class="btn bg-white border remove-win" data-id="${w.id}">Remove</button>
            </div>
          </div>
        `;
        winnersList.appendChild(el);
      });

      winnersList.querySelectorAll('.remove-win').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Remove this winner?')) return;

          try {
            // 1) Delete any giveaway doc that points to this winner (winnerId)
            try {
              const q = query(collection(db, GIVEAWAYS_COLLECTION_PATH), where('winnerId', '==', id));
              const snap = await getDocs(q);
              for (const gdoc of snap.docs) {
                await deleteDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${gdoc.id}`));
              }
            } catch (err) {
              // non-fatal: log and continue to delete winner doc anyway
              console.warn('Could not delete linked giveaway docs (non-fatal):', err);
            }

            // 2) Delete winner doc
            await deleteDoc(doc(db, `${WINNERS_COLLECTION_PATH}/${id}`));
          } catch(err) {
            console.error('delete winner failed', err);
            alert('Could not remove winner: ' + (err.message || err));
          }
        });
      });
    }

    // ---------- createWinner: writes to winners ONLY (no auto-giveaway duplication) ----------
    async function createWinner() {
      if (!createWinBtn) return;
      if (winError) winError.classList.add('hidden-el');
      if (winStatus) winStatus.textContent = '';
      const nameVal = winName?.value?.trim() || '';
      const handleVal = winHandle?.value?.trim() || '';
      const prizeVal = winPrize?.value?.trim() || '';
      const file = winImageFile?.files && winImageFile.files[0];

      if (!nameVal || !prizeVal) {
        if (winError) { winError.classList.remove('hidden-el'); winError.textContent = 'Please add name and prize.'; }
        return;
      }

      createWinBtn.disabled = true;
      createWinBtn.textContent = 'Posting...';

      try {
  let imageUrl = '';
  let publicId = '';

  // Upload to Cloudinary if a file was selected
  if (file) {
    const cloudResp = await uploadToCloudinary(file);
    if (!cloudResp || !cloudResp.secure_url) {
      throw new Error('Cloudinary did not return secure_url');
    }
    imageUrl = cloudResp.secure_url;
    publicId = cloudResp.public_id;
  }

  // Build the Firestore payload
  const winnerPayload = {
    name: nameVal,
    handle: handleVal || '',
    prize: prizeVal,
    imageUrl: imageUrl || '',
    publicId: publicId || '',
    createdAt: serverTimestamp(),
    uploader: auth && auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'admin',
    // Add this so the public winners page will include it if it filters by "published"
    published: true
  };

  // Debug logs
  console.log('DEBUG: manual winnerPayload about to be saved:', winnerPayload);
  console.log('DEBUG: WINNERS_COLLECTION_PATH =', WINNERS_COLLECTION_PATH);

  // Save to the winners collection
  const savedRef = await addDoc(collection(db, WINNERS_COLLECTION_PATH), winnerPayload);
  console.log('DEBUG: manual winner saved id', savedRef.id);

  // Success alert (keep your existing UI flow)
  alert('Winner saved successfully! (id: ' + savedRef.id + ')');

} catch (err) {
  console.error('ERROR: manual winner save failed', err);
  alert('Could not save winner: ' + (err && err.message ? err.message : err));
}


    if (winStatus) winStatus.textContent = 'Winner saved.';
        // clear form
      winName.value=''; winHandle.value=''; winPrize.value=''; if (winImageFile) winImageFile.value='';
      console.error('create winner failed', err);
      createWinBtn.disabled = false;
      createWinBtn.textContent = 'Add Winner';
    }

    if (createWinBtn) {
      createWinBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createWinner();
      });
    }

    // ---------- Quick pick winner (admin-only) ----------
    /**
     * quickPickWinner(giveId, giveTitle)
     *
     * - Tries the top-level ENTRIES_COLLECTION_PATH (recommended) for documents where
     *   giveawayId == giveId && validated == true
     * - If none found, falls back to subcollection `${GIVEAWAYS_COLLECTION_PATH}/${giveId}/entries`
     * - Picks a random validated entry, shows an admin preview modal with entrant info + screenshot
     * - On confirm, creates a winners doc and updates the giveaway to status 'winner' and winnerId
     */
    async function quickPickWinner(giveId, giveTitle) {
      if (!giveId) return alert('Giveaway id missing.');
      try {
        // 1) attempt top-level entries collection first
        let validEntries = [];
        try {
          const qTop = query(collection(db, ENTRIES_COLLECTION_PATH), where('giveawayId', '==', giveId), where('validated', '==', true));
          const snapTop = await getDocs(qTop);
          validEntries = snapTop.docs.map(d => ({ id: d.id, ...d.data(), __path: `${ENTRIES_COLLECTION_PATH}/${d.id}` }));
        } catch (errTop) {
          console.warn('Top-level entries read failed (continuing to fallback):', errTop);
        }

        // 2) fallback to subcollection under giveaway if none found
        if (!validEntries.length) {
          try {
            const subPath = `${GIVEAWAYS_COLLECTION_PATH}/${giveId}/entries`;
            const qSub = query(collection(db, subPath), where('validated', '==', true));
            const snapSub = await getDocs(qSub);
            validEntries = snapSub.docs.map(d => ({ id: d.id, ...d.data(), __path: `${subPath}/${d.id}` }));
          } catch (errSub) {
            console.warn('Subcollection entries read failed:', errSub);
          }
        }

        if (!validEntries.length) {
          return alert('No validated entries found for this giveaway.');
        }

        // pick random entry
        const pick = validEntries[Math.floor(Math.random() * validEntries.length)];
        const name = pick.name || pick.fullName || pick.entryName || 'No name';
        const handle = pick.handle || pick.instagram || pick.social || '';
        const note = pick.note || pick.notes || pick.caption || '';
        const image = pick.imageUrl || pick.screenshotUrl || pick.submissionImage || '';

        // show preview modal
        showQuickPickPreviewModal({
          giveawayId: giveId,
          giveawayTitle: giveTitle || '',
          entry: pick,
          name,
          handle,
          note,
          image
        });

      } catch (err) {
        console.error('quickPickWinner failed', err);
        alert('Could not pick a winner: ' + (err.message || err));
      }
    }

    // helper: create and show preview modal, handle confirm/cancel
    function showQuickPickPreviewModal({ giveawayId, giveawayTitle, entry, name, handle, note, image }) {
  // create modal backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'qp-backdrop';
  backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999;';

  // modal container
  const modal = document.createElement('div');
  modal.className = 'qp-modal';
  modal.style.cssText = 'background:white;padding:20px;border-radius:12px;max-width:760px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.15);';

  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="font-weight:800;font-size:1.05rem;color:#be185d;">Preview Winner — ${escapeHtml(giveawayTitle || 'Giveaway')}</div>
      <div style="color:#6b7280;font-size:.95rem;">Entry ID: ${escapeHtml(entry.id || '')}</div>
    </div>

    <div style="display:flex;gap:20px;">
      <div style="flex:1;">
        <div style="font-weight:700;">${escapeHtml(name || '')}</div>
        <div style="margin-top:6px;color:#6b7280;font-size:.9rem;">Handle: ${escapeHtml(handle || '')}</div>
        <div style="margin-top:8px;color:#6b7280;font-size:.9rem;">${escapeHtml(note || '')}</div>

        <div style="margin-top:16px;display:flex;gap:10px;">
          <button id="qpConfirm" class="px-4 py-2 rounded bg-rose-600 text-white font-semibold">Confirm & Save winner</button>
          <button id="qpCancel" class="px-4 py-2 rounded border">Cancel</button>
        </div>

        <div style="margin-top:12px;color:#6b7280;font-size:.85rem;">
          This will create a winner record and mark the giveaway as <strong>winner</strong>. Screenshot will <strong>NOT</strong> be saved publicly.
        </div>
      </div>

      <div style="width:300px;">
        ${ image ? `<img src="${escapeHtml(image)}" style="width:100%;border-radius:10px;object-fit:contain;"/>` : `<div style='width:100%;height:260px;background:#f3f4f6;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;'>No Screenshot</div>` }
      </div>
    </div>
  `;

  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);

  const closeModal = () => { if (backdrop && backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); };

  modal.querySelector('#qpCancel').addEventListener('click', closeModal);

  modal.querySelector('#qpConfirm').addEventListener('click', async () => {
    const btn = modal.querySelector('#qpConfirm');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
      // IMPORTANT: do NOT save the entrant screenshot into the winners collection
      const winnerPayload = {
        name: name || '',
        handle: handle || '',
        prize: giveawayTitle || '',
        imageUrl: '', // intentionally left blank for quick-picked winners
        sourceGiveawayId: giveawayId || '',
        entryId: entry && entry.id ? entry.id : '',
        createdAt: serverTimestamp(),
        uploader: auth && auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'admin'
      };

      // save to winners collection (the public winners collection)
      const winnerRef = await addDoc(collection(db, WINNERS_COLLECTION_PATH), winnerPayload);

      // update giveaway doc to link winnerId & set status (best-effort)
      try {
        await updateDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${giveawayId}`), { winnerId: winnerRef.id, status: 'winner' });
      } catch (err) {
        console.warn('Non-fatal: could not update giveaway with winnerId/status', err);
      }

      // mark entry as used (best-effort)
      try {
        const entryPath = entry && entry.__path ? entry.__path : '';
        if (entryPath) {
          await updateDoc(doc(db, entryPath), { pickedAsWinnerAt: serverTimestamp(), pickedAsWinnerFor: giveawayId });
        } else {
          try { await updateDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${giveawayId}/entries/${entry.id}`), { pickedAsWinnerAt: serverTimestamp(), pickedAsWinnerFor: giveawayId }); } catch(e) {}
          try { await updateDoc(doc(db, `${ENTRIES_COLLECTION_PATH}/${entry.id}`), { pickedAsWinnerAt: serverTimestamp(), pickedAsWinnerFor: giveawayId }); } catch(e) {}
        }
      } catch (err) {
        console.warn('Non-fatal: could not mark entry as used', err);
      }

      alert('Winner saved successfully!');
      closeModal();

      // optional: reload admin lists if those functions exist
      if (typeof loadWinnersAdmin === 'function') loadWinnersAdmin();
      if (typeof loadGiveaways === 'function') loadGiveaways();

    } catch (err) {
      console.error('Failed to save winner', err);
      alert('Failed to save winner: ' + (err && err.message ? err.message : err));
      btn.disabled = false;
      btn.textContent = 'Confirm & Save winner';
    }
  });

  backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
}

    // ---------- FIXTURES admin functions (UPDATED) ----------
    async function loadFixturesAdmin() {
      fixturesList.innerHTML = '<div class="text-gray-500">Loading fixtures…</div>';
      fxError.classList.add('hidden-el');
      fxStatusMsg.textContent = '';
      try {
        const ref = collection(db, FIXTURES_COLLECTION_PATH);
        onSnapshot(ref, snap => {
          const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          docs.sort((a,b) => (a.kickoffTs?.seconds ?? 0) - (b.kickoffTs?.seconds ?? 0));
          renderFixturesAdmin(docs);
        }, err => {
          console.error('fixtures onSnapshot error', err);
          fixturesList.innerHTML = '<div class="text-red-600">Could not load fixtures.</div>';
        });
      } catch (err) {
        console.error('loadFixturesAdmin failed', err);
        fixturesList.innerHTML = '<div class="text-red-600">Could not load fixtures.</div>';
        fxError.classList.remove('hidden-el');
        fxError.textContent = 'Could not read fixtures: ' + (err.message || err.code || err);
      }
    }

    function renderFixturesAdmin(docs) {
      fixturesList.innerHTML = '';
      if (!docs.length) { fixturesList.innerHTML = '<div class="text-gray-500">No fixtures yet.</div>'; return; }
      docs.forEach(f => {
        const el = document.createElement('div');
        el.className = 'fixture-row';
        const dateLabel = f.kickoffTs && f.kickoffTs.seconds ? new Date(f.kickoffTs.seconds*1000).toLocaleString() : (f.kickoffISO || '');
        const scorePresent = (typeof f.scoreHome !== 'undefined' && typeof f.scoreAway !== 'undefined' && f.scoreHome !== null && f.scoreAway !== null);
        el.innerHTML = `
          <img class="fixture-thumb" src="${escapeHtml(f.teamALogoUrl || 'images/opponent.png')}" onerror="this.onerror=null;this.src='images/opponent.png'"/>
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:.5rem;">
              <div style="font-weight:700">${escapeHtml(f.teamA || 'Team A')}</div>
              <div style="color:#94a3b8;font-size:.85rem;">vs</div>
              <div style="font-weight:700">${escapeHtml(f.teamB || 'Team B')}</div>
              <div style="margin-left:auto;color:#6b7280;font-size:.9rem;">${escapeHtml(f.ageGroup || '')} · ${escapeHtml(f.status || '')}</div>
            </div>
            <div style="color:#6b7280;font-size:.9rem;margin-top:.25rem;">${escapeHtml(dateLabel)} ${ f.venue ? '· ' + escapeHtml(f.venue) : '' }</div>
            <div style="margin-top:.25rem;color:#374151;">${escapeHtml(f.broadcast || '')}</div>
            <div style="margin-top:.25rem;color:#374151;font-weight:800;">${ scorePresent ? (escapeHtml(String(f.scoreHome)) + ' : ' + escapeHtml(String(f.scoreAway))) : '' }</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem;">
            <button class="btn bg-white border edit-fx" data-id="${f.id}">Edit</button>
            <button class="btn bg-white border delete-fx" data-id="${f.id}">Delete</button>
          </div>
        `;
        fixturesList.appendChild(el);
      });

      fixturesList.querySelectorAll('.edit-fx').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          try {
            const snapAll = await getDocs(query(collection(db, FIXTURES_COLLECTION_PATH)));
            const found = snapAll.docs.find(d => d.id === id);
            if (!found) throw new Error('Fixture not found');
            const data = found.data();
            currentEditFxId = id;
            fxAgeGroup.value = data.ageGroup || 'Senior';
            if (data.kickoffTs && data.kickoffTs.seconds) {
              const dt = new Date(data.kickoffTs.seconds*1000);
              fxKickoff.value = dt.toISOString().slice(0,16);
            } else if (data.kickoffISO) {
              try { fxKickoff.value = new Date(data.kickoffISO).toISOString().slice(0,16); } catch(e){ fxKickoff.value = ''; }
            } else { fxKickoff.value = ''; }
            fxStatus.value = data.status || 'scheduled';
            fxTeamA.value = data.teamA || '';
            fxTeamB.value = data.teamB || '';
            fxVenue.value = data.venue || '';
            fxStream.value = data.streamUrl || '';
            fxBroadcast.value = data.broadcast || '';

            // populate scores if present
            fxScoreA.value = (typeof data.scoreHome !== 'undefined' && data.scoreHome !== null) ? String(data.scoreHome) : '';
            fxScoreB.value = (typeof data.scoreAway !== 'undefined' && data.scoreAway !== null) ? String(data.scoreAway) : '';

            createFxBtn.classList.add('hidden-el');
            updateFxBtn.classList.remove('hidden-el');
            cancelFxEditBtn.classList.remove('hidden-el');
            fxStatusMsg.textContent = 'Editing fixture — remember to Save changes.';
            window.scrollTo({top: fixturesList.offsetTop - 20, behavior: 'smooth'});
          } catch (err) {
            console.error('Edit fixture load failed', err);
            alert('Could not load fixture for editing: ' + (err.message || err));
          }
        });
      });

      fixturesList.querySelectorAll('.delete-fx').forEach(b => {
        b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.getAttribute('data-id');
          if (!confirm('Delete this fixture?')) return;
          try {
            await deleteDoc(doc(db, `${FIXTURES_COLLECTION_PATH}/${id}`));
          } catch (err) {
            console.error('Delete fixture failed', err);
            alert('Could not delete fixture: ' + (err.message || err));
          }
        });
      });
    }

    // create fixture handler
    createFxBtn.addEventListener('click', async () => {
      fxError.classList.add('hidden-el');
      fxStatusMsg.textContent = '';
      const ageGroup = (fxAgeGroup.value || 'Senior');
      const kickoffVal = fxKickoff.value ? new Date(fxKickoff.value) : null;
      const status = (fxStatus.value || 'scheduled');
      const teamA = (fxTeamA.value || '').trim();
      const teamB = (fxTeamB.value || '').trim();
      const venue = (fxVenue.value || '').trim();
      const streamUrl = (fxStream.value || '').trim();
      const broadcast = (fxBroadcast.value || '').trim();
      const teamAFile = fxTeamAFile.files && fxTeamAFile.files[0];
      const teamBFile = fxTeamBFile.files && fxTeamBFile.files[0];
      const scoreAVal = fxScoreA.value !== '' ? Number(fxScoreA.value) : null;
      const scoreBVal = fxScoreB.value !== '' ? Number(fxScoreB.value) : null;

      if (!teamA || !teamB || !kickoffVal) {
        fxError.classList.remove('hidden-el');
        fxError.textContent = 'Please add both team names and kickoff date/time.';
        return;
      }

      createFxBtn.disabled = true;
      createFxBtn.textContent = 'Saving...';

      try {
        let teamALogoUrl = '';
        let teamBLogoUrl = '';

        if (teamAFile) {
          const resp = await uploadToCloudinary(teamAFile);
          teamALogoUrl = resp.secure_url;
        }
        if (teamBFile) {
          const resp = await uploadToCloudinary(teamBFile);
          teamBLogoUrl = resp.secure_url;
        }

        await addDoc(collection(db, FIXTURES_COLLECTION_PATH), {
          ageGroup,
          kickoffTs: serverTimestamp(), // placeholder; canonical stored as kickoffISO
          kickoffISO: kickoffVal.toISOString(),
          status,
          teamA,
          teamB,
          venue,
          teamALogoUrl: teamALogoUrl || '',
          teamBLogoUrl: teamBLogoUrl || '',
          streamUrl: streamUrl || '',
          broadcast: broadcast || '',
          // scores: null if not provided
          scoreHome: scoreAVal !== null ? scoreAVal : null,
          scoreAway: scoreBVal !== null ? scoreBVal : null,
          createdAt: serverTimestamp()
        });

        fxStatusMsg.textContent = 'Fixture created.';
        // clear form
        fxAgeGroup.value = 'Senior';
        fxKickoff.value = '';
        fxStatus.value = 'scheduled';
        fxTeamA.value = '';
        fxTeamB.value = '';
        fxVenue.value = '';
        fxTeamAFile.value = '';
        fxTeamBFile.value = '';
        fxStream.value = '';
        fxBroadcast.value = '';
        fxScoreA.value = '';
        fxScoreB.value = '';
      } catch (err) {
        console.error('Create fixture failed', err);
        fxError.classList.remove('hidden-el');
        fxError.textContent = 'Create failed: ' + (err.message || err.code || err);
      } finally {
        createFxBtn.disabled = false;
        createFxBtn.textContent = 'Create fixture';
      }
    });

    // update fixture handler
    updateFxBtn.addEventListener('click', async () => {
      if (!currentEditFxId) return;
      fxError.classList.add('hidden-el');
      fxStatusMsg.textContent = '';

      const ageGroup = (fxAgeGroup.value || 'Senior');
      const kickoffVal = fxKickoff.value ? new Date(fxKickoff.value) : null;
      const status = (fxStatus.value || 'scheduled');
      const teamA = (fxTeamA.value || '').trim();
      const teamB = (fxTeamB.value || '').trim();
      const venue = (fxVenue.value || '').trim();
      const streamUrl = (fxStream.value || '').trim();
      const broadcast = (fxBroadcast.value || '').trim();
      const teamAFile = fxTeamAFile.files && fxTeamAFile.files[0];
      const teamBFile = fxTeamBFile.files && fxTeamBFile.files[0];
      const scoreAVal = fxScoreA.value !== '' ? Number(fxScoreA.value) : null;
      const scoreBVal = fxScoreB.value !== '' ? Number(fxScoreB.value) : null;

      if (!teamA || !teamB || !kickoffVal) {
        fxError.classList.remove('hidden-el');
        fxError.textContent = 'Please add both team names and kickoff date/time.';
        return;
      }

      updateFxBtn.disabled = true;
      updateFxBtn.textContent = 'Saving...';

      try {
        let payload = {
          ageGroup,
          status,
          teamA,
          teamB,
          venue,
          streamUrl: streamUrl || '',
          broadcast: broadcast || '',
          updatedAt: serverTimestamp(),
          // set scores (null will clear)
          scoreHome: scoreAVal !== null ? scoreAVal : null,
          scoreAway: scoreBVal !== null ? scoreBVal : null
        };
        if (kickoffVal) payload.kickoffISO = kickoffVal.toISOString();

        if (teamAFile) {
          const respA = await uploadToCloudinary(teamAFile);
          payload.teamALogoUrl = respA.secure_url;
        }
        if (teamBFile) {
          const respB = await uploadToCloudinary(teamBFile);
          payload.teamBLogoUrl = respB.secure_url;
        }

        await updateDoc(doc(db, `${FIXTURES_COLLECTION_PATH}/${currentEditFxId}`), payload);

        fxStatusMsg.textContent = 'Fixture updated.';
        currentEditFxId = null;
        // reset form
        fxAgeGroup.value = 'Senior';
        fxKickoff.value = '';
        fxStatus.value = 'scheduled';
        fxTeamA.value = '';
        fxTeamB.value = '';
        fxVenue.value = '';
        fxTeamAFile.value = '';
        fxTeamBFile.value = '';
        fxStream.value = '';
        fxBroadcast.value = '';
        fxScoreA.value = '';
        fxScoreB.value = '';
        createFxBtn.classList.remove('hidden-el');
        updateFxBtn.classList.add('hidden-el');
        cancelFxEditBtn.classList.add('hidden-el');
      } catch (err) {
        console.error('Update fixture failed', err);
        fxError.classList.remove('hidden-el');
        fxError.textContent = 'Update failed: ' + (err.message || err.code || err);
      } finally {
        updateFxBtn.disabled = false;
        updateFxBtn.textContent = 'Save changes';
      }
    });

    cancelFxEditBtn.addEventListener('click', () => {
      currentEditFxId = null;
      fxAgeGroup.value = 'Senior';
      fxKickoff.value = '';
      fxStatus.value = 'scheduled';
      fxTeamA.value = '';
      fxTeamB.value = '';
      fxVenue.value = '';
      fxTeamAFile.value = '';
      fxTeamBFile.value = '';
      fxStream.value = '';
      fxBroadcast.value = '';
      fxScoreA.value = '';
      fxScoreB.value = '';
      createFxBtn.classList.remove('hidden-el');
      updateFxBtn.classList.add('hidden-el');
      cancelFxEditBtn.classList.add('hidden-el');
      fxStatusMsg.textContent = '';
    });

    // ---------- start: ensure auth + show admin -->
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        signInAnonymously(auth).catch(err => {
          console.warn('Anonymous sign-in failed (not fatal):', err);
        });
      }
    });

    // done
  </script>
</body>
</html>
