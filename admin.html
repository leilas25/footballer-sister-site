<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADMIN • The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .btn { padding:.6rem 1rem; border-radius:9999px; font-weight:600; }
    .small-muted { font-size:.95rem; color:#7a7a7a; }
    .hidden-el { display:none !important; }
    .muted { color:#6b7280; }
    .response-box { width:100%; min-height:70px; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
    .error-box { background:#fff1f2; border:1px solid #fecaca; padding:.75rem; border-radius:8px; color:#991b1b; }
    /* gallery list */
    .collab-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:12px;}
    .collab-card { border-radius:12px; overflow:hidden; background:#fff; border:1px solid rgba(0,0,0,0.04); box-shadow:0 6px 18px rgba(11,7,17,0.04); }
    .collab-thumb { width:100%; height:160px; object-fit:cover; display:block; background:#f3f4f6; }
    .collab-body { padding:10px; }
    .collab-meta { color:#6b7280; font-size:.85rem; margin-top:6px; }
  </style>
</head>
<body class="bg-pink-50 font-sans text-black">

  <header class="bg-pink-100 sticky top-0 z-40 shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold uppercase text-rose-600">ADMIN • THE FOOTBALLER’S SISTER</h1>
      <a href="index.html" class="text-rose-600 hover:underline">Home</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- LOGIN -->
    <section id="loginSection" class="card mx-auto max-w-md">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Admin sign-in</h2>
      <p class="small-muted mb-4">Enter the admin email & password. No admin content will be shown until the correct admin signs in.</p>

      <form id="loginForm" class="grid gap-3">
        <input id="email" type="email" placeholder="Admin email" autocomplete="username" required class="p-3 rounded border" />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" required class="p-3 rounded border" />
        <div class="flex gap-3">
          <button id="signInBtn" type="submit" class="btn bg-rose-600 text-white">Sign in</button>
          <button id="cancelBtn" type="button" class="btn bg-white border" onclick="email.value='';password.value='';">Clear</button>
        </div>
      </form>

      <p id="loginMessage" class="mt-3 small-muted"></p>
    </section>

    <!-- ADMIN UI -->
    <section id="adminUI" class="hidden-el" aria-hidden="true">
      <div class="flex gap-3 items-center mb-6">
        <button id="navSupport" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Support Wall</button>
        <button id="navQA" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Q&A</button>
        <button id="navFixtures" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Fixtures</button>
        <button id="navMedia" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Media / Gallery</button>
        <button id="navWinners" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Winners</button>
        <button id="navGiveaways" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Giveaways</button>

        <div class="ml-auto text-sm small-muted">
          Signed in as <span id="adminEmailDisplay"></span>
          <button id="signOutBtn" class="btn bg-rose-600 text-white ml-4">Log out</button>
        </div>
      </div>

      <div id="panes" class="space-y-6">

        <!-- Support Wall pane (IMPROVED) -->
        <div id="paneSupport" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Support Wall (admin)</h3>
          <p class="small-muted mb-3">All messages from the Support Wall are listed below. You can delete any message.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshSupportBtn" class="btn bg-white border">Refresh messages</button>
            <div id="supportStatus" class="text-sm muted"></div>
          </div>
          <div id="supportError" class="error-box hidden-el"></div>
          <div id="supportList" class="space-y-3">No messages yet.</div>
        </div>

        <!-- Q&A pane (IMPROVED with respond) -->
        <div id="paneQA" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Q&A (admin)</h3>
          <p class="small-muted mb-3">Respond to user questions or delete any you don't want on the site.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshQABtn" class="btn bg-white border">Refresh questions</button>
            <div id="qaStatus" class="text-sm muted"></div>
          </div>
          <div id="qaError" class="error-box hidden-el"></div>
          <div id="qaList" class="space-y-4"></div>
        </div>

        <!-- Media / Gallery pane (NEW: Cloudinary unsigned upload + Firestore metadata) -->
        <div id="paneMedia" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Media / Gallery (admin)</h3>
          <p class="small-muted mb-3">Add images to the collabs carousel on the BTS page. Each image stores a caption and Cloudinary info.</p>

          <!-- Upload form -->
          <form id="collabForm" class="grid gap-3 mb-4">
            <div class="flex gap-3">
              <input id="collabFile" type="file" accept="image/*" class="p-2 rounded border bg-white" required />
              <input id="collabCaption" type="text" maxlength="200" placeholder="Caption (optional)" class="p-2 rounded border flex-1" />
            </div>
            <div class="flex gap-3 items-center">
              <button id="uploadCollabBtn" type="submit" class="btn bg-rose-600 text-white">Upload to Cloudinary & Save</button>
              <div id="collabStatus" class="small-muted"></div>
            </div>
          </form>

          <!-- Collabs list -->
          <div id="collabsList" class="collab-grid"></div>
          <div id="collabsError" class="error-box hidden-el mt-3"></div>
        </div>

        <div id="paneWinners" class="card hidden-el"><h3 class="text-lg font-bold">Winners (unchanged)</h3></div>
        <div id="paneFixtures" class="card hidden-el"><h3 class="text-lg font-bold">Fixtures (unchanged)</h3></div>
        <div id="paneGiveaways" class="card hidden-el"><h3 class="text-lg font-bold">Giveaways (unchanged)</h3></div>

      </div>
    </section>
  </main>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; 2025 The Footballer’s Sister. All rights reserved.</p>
  </footer>

  <!-- Firebase + Admin JS (module) -->
  <script type="module">
    /**************************************************************************
     * Admin JS - with Cloudinary unsigned upload support for collabs
     **************************************************************************/

    // ---------- CONFIG ----------
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";
    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db"
    };
    const APP_ID = firebaseConfig.appId;

    // Cloudinary config (replaced with the value you provided)
    const CLOUDINARY_CLOUD_NAME = "dk1df1qmi";
    const CLOUDINARY_UNSIGNED_PRESET = "unsigned_bts_preset";

    // Candidate bases to try (artifact path first)
    const CANDIDATE_BASES = [
      `/artifacts/${APP_ID}/public/data`,
      `/artifacts/${APP_ID}/public`,
      `/artifacts/${APP_ID}`,
      `/public/data`,
      '' // top-level
    ];

    // ---------- IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, orderBy,
      addDoc, serverTimestamp, onSnapshot, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- DOM ----------
    const loginSection = document.getElementById('loginSection');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    const adminUI = document.getElementById('adminUI');
    const adminEmailDisplay = document.getElementById('adminEmailDisplay');
    const signOutBtn = document.getElementById('signOutBtn');

    const navSupport = document.getElementById('navSupport');
    const navQA = document.getElementById('navQA');
    const navMedia = document.getElementById('navMedia');

    const paneSupport = document.getElementById('paneSupport');
    const paneQA = document.getElementById('paneQA');
    const paneMedia = document.getElementById('paneMedia');

    const refreshSupportBtn = document.getElementById('refreshSupportBtn');
    const supportList = document.getElementById('supportList');
    const supportStatus = document.getElementById('supportStatus');
    const supportError = document.getElementById('supportError');

    const refreshQABtn = document.getElementById('refreshQABtn');
    const qaList = document.getElementById('qaList');
    const qaStatus = document.getElementById('qaStatus');
    const qaError = document.getElementById('qaError');

    // Media pane elements
    const collabForm = document.getElementById('collabForm');
    const collabFile = document.getElementById('collabFile');
    const collabCaption = document.getElementById('collabCaption');
    const uploadCollabBtn = document.getElementById('uploadCollabBtn');
    const collabStatus = document.getElementById('collabStatus');
    const collabsList = document.getElementById('collabsList');
    const collabsError = document.getElementById('collabsError');

    function hideAllPanes() {
      [paneSupport, paneQA, paneMedia].forEach(p => p.classList.add('hidden-el'));
    }

    // ---------- AUTH ----------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMessage.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      } catch (err) {
        console.error('Sign-in error', err);
        loginMessage.textContent = 'Sign-in failed: ' + (err.message || '');
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        loginSection.classList.remove('hidden-el');
        adminUI.classList.add('hidden-el');
        hideAllPanes();
        return;
      }
      if (user.uid !== ADMIN_UID) {
        signOut(auth).catch(()=>{});
        loginMessage.textContent = 'Not admin account. Signed out.';
        return;
      }
      loginSection.classList.add('hidden-el');
      adminUI.classList.remove('hidden-el');
      adminEmailDisplay.textContent = user.email || user.uid;
      // show support by default for convenience
      showSupportPane();
    });

    signOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); loginMessage.textContent = 'Signed out.'; } catch(e){ console.error(e); }
    });

    // NAV
    navSupport.addEventListener('click', showSupportPane);
    navQA.addEventListener('click', showQAPane);
    navMedia.addEventListener('click', showMediaPane);

    function showSupportPane(){ hideAllPanes(); paneSupport.classList.remove('hidden-el'); loadSupport(); }
    function showQAPane(){ hideAllPanes(); paneQA.classList.remove('hidden-el'); loadQA(); }
    function showMediaPane(){ hideAllPanes(); paneMedia.classList.remove('hidden-el'); subscribeCollabs(); }

    refreshSupportBtn.addEventListener('click', loadSupport);
    refreshQABtn.addEventListener('click', loadQA);

    // ---------- UTIL helpers ----------
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // try to read a collection at a specific base path, returning an object:
    // { success: true, docs: [...], base, path } or { success:false, error, base, path }
    async function tryReadCollectionAtBase(base, collectionName) {
      const path = base ? `${base}/${collectionName}` : collectionName;
      try {
        const q = query(collection(db, path));
        const snap = await getDocs(q);
        return { success: true, docs: snap.docs.map(d => ({ id: d.id, data: d.data() })), base, path };
      } catch (err) {
        return { success: false, error: err, base, path };
      }
    }

    async function autoDetectAndRead(collectionName) {
      let firstError = null;
      for (const base of CANDIDATE_BASES) {
        const res = await tryReadCollectionAtBase(base, collectionName);
        if (res.success) return res;
        if (!firstError) firstError = res;
        console.warn('Read error for', res.path, res.error && res.error.code ? res.error.code : res.error);
      }
      return firstError;
    }

    // ---------- SUPPORT: load, render, delete ----------
    async function loadSupport() {
      supportStatus.textContent = 'Loading...';
      supportError.classList.add('hidden-el');
      supportList.innerHTML = '';
      const res = await autoDetectAndRead('supportMessages');
      if (res && res.success) {
        supportStatus.textContent = `Loaded from: ${res.base || 'top-level'}`;
        const docs = res.docs;
        if (!docs.length) {
          supportList.innerHTML = '<div class="text-gray-500">No messages yet.</div>';
          return;
        }
        docs.sort((a,b) => {
          const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
          const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
          return tb - ta;
        });
        renderSupportDocs(docs, res.path);
      } else {
        console.error('Support read error:', res);
        supportStatus.textContent = 'Load failed';
        supportError.classList.remove('hidden-el');
        supportError.innerHTML = `<strong>Error reading supportMessages</strong><br> Path tried: <code>${res.path}</code><br> Error: ${escapeHtml(res.error && (res.error.message||res.error.code) || String(res.error))}<br><br>Check Firestore rules (allow read) or that the docs exist at this path.`;
      }
    }

    function renderSupportDocs(docs, basePath) {
      supportList.innerHTML = '';
      docs.forEach(it => {
        const d = it.data || {};
        const timeLabel = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : 'Unknown';
        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded shadow flex items-start gap-3';
        el.innerHTML = `
          <div style="width:48px;flex-shrink:0;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="#be185d"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10s-2.5-1.12-2.5-2.5S10.62 5 12 5zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
          </div>
          <div style="flex:1">
            <div style="display:flex;gap:.5rem;align-items:center;">
              <div style="font-weight:700">${escapeHtml(d.name || 'Anonymous')}</div>
              <div style="color:#94a3b8;font-size:.85rem">@${(d.userId||'').substring(0,8)}</div>
              <div style="color:#94a3b8;font-size:.75rem;margin-left:.5rem;">· ${timeLabel}</div>
            </div>
            <div style="margin-top:.6rem;color:#374151;">${escapeHtml(d.message || '')}</div>
            <div style="margin-top:.6rem;color:#6b7280;font-size:.9rem;">${ d.adminResponse ? `<strong>Admin:</strong> ${escapeHtml(d.adminResponse)} <span class="muted">· ${d.respondedAt && d.respondedAt.seconds ? new Date(d.respondedAt.seconds*1000).toLocaleString() : ''}</span>` : '<span class="muted">No admin response yet.</span>' }</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem;">
            <button class="delete-support btn bg-white border" data-id="${it.id}" data-base="${basePath}">Delete</button>
          </div>
        `;
        supportList.appendChild(el);
      });

      supportList.querySelectorAll('.delete-support').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          if (!confirm('Delete message?')) return;
          try {
            const { doc: docRefFunc, deleteDoc: deleteDocFunc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(m => ({ doc: m.doc, deleteDoc: m.deleteDoc }));
            const fullPath = `${basePath}/${id}`;
            await deleteDocFunc(docRefFunc(db, fullPath));
            loadSupport();
          } catch (err) {
            console.error('Delete failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // ---------- Q&A: load, render, respond, delete ----------
    // (we reuse the robust getQuestionText from your previous file)
    function getQuestionText(data) {
      if (!data || typeof data !== 'object') return '';

      const keys = [
        'body','message','question','text','q','description','content','msg',
        'questionText','question_text','questionBody','question_body','questionTxt',
        'question_message','message_text','bodyText','body_text','contentText','content_text',
        'ask','ask_text','userQuestion','user_question','input','questionValue'
      ];

      const hasKeyWithValue = (obj, key) => {
        if (!obj) return null;
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] && String(obj[key]).trim()) return String(obj[key]);
        const lower = key.toLowerCase();
        for (const k of Object.keys(obj)) {
          if (k.toLowerCase() === lower && obj[k] && String(obj[k]).trim()) return String(obj[k]);
        }
        return null;
      };

      for (const k of keys) {
        const v = hasKeyWithValue(data, k);
        if (v) return v;
      }
      for (const k of Object.keys(data)) {
        const v = data[k];
        if (typeof v === 'string' && v.trim()) return v;
      }
      for (const k of Object.keys(data)) {
        const v = data[k];
        if (v && typeof v === 'object') {
          for (const cand of keys) {
            const nested = hasKeyWithValue(v, cand);
            if (nested) return nested;
          }
          for (const nk of Object.keys(v)) {
            if (typeof v[nk] === 'string' && String(v[nk]).trim()) return v[nk];
          }
        }
      }
      const queue = [{obj:data,depth:0}];
      const seen = new Set();
      while (queue.length) {
        const {obj, depth} = queue.shift();
        if (!obj || typeof obj !== 'object' || depth > 2) continue;
        for (const key of Object.keys(obj)) {
          const val = obj[key];
          if (typeof val === 'string' && val.trim()) return val;
          if (val && typeof val === 'object' && !seen.has(val)) {
            seen.add(val);
            queue.push({obj: val, depth: depth + 1});
          }
        }
      }
      return '';
    }

    async function loadQA() {
      qaStatus.textContent = 'Loading...';
      qaError.classList.add('hidden-el');
      qaList.innerHTML = '';
      const res = await autoDetectAndRead('questions');
      if (res && res.success) {
        qaStatus.textContent = `Loaded from: ${res.base || 'top-level'}`;
        const docs = res.docs;
        if (!docs.length) { qaList.innerHTML = '<div class="text-gray-500">No questions yet.</div>'; return; }
        docs.sort((a,b) => {
          const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
          const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
          return tb - ta;
        });
        renderQADocs(docs, res.path);
      } else {
        console.error('Q&A read error:', res);
        qaStatus.textContent = 'Load failed';
        qaError.classList.remove('hidden-el');
        qaError.innerHTML = `<strong>Error reading questions</strong><br> Path tried: <code>${res.path}</code><br> Error: ${escapeHtml(res.error && (res.error.message||res.error.code) || String(res.error))}<br><br>Check Firestore rules (allow read) or that the docs exist at this path.`;
      }
    }

    function renderQADocs(docs, basePath) {
      qaList.innerHTML = '';
      docs.forEach(it => {
        const d = it.data || {};
        const timeLabel = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : 'Unknown';
        const questionText = getQuestionText(d) || '';

        const el = document.createElement('div');
        el.className = 'bg-white p-3 rounded shadow';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
            <div style="flex:1">
              <div style="font-weight:700">${escapeHtml(d.title || 'Question')}</div>
              <div style="color:#374151;margin-top:.4rem;">${ questionText ? escapeHtml(questionText) : '<span class="muted">[Question text unavailable]</span>' }</div>
              <div style="color:#94a3b8;font-size:.85rem;margin-top:.5rem;">From: ${escapeHtml(d.name || 'Anonymous')} ${ timeLabel ? '· ' + escapeHtml(timeLabel) : '' }</div>

              <div style="margin-top:.8rem;">
                <div style="font-size:.9rem;color:#6b7280;margin-bottom:.5rem;">Admin response (saved to Firestore):</div>
                <textarea class="response-box" data-id="${it.id}">${d.adminResponse ? escapeHtml(d.adminResponse) : ''}</textarea>
                <div class="mt-2 flex gap-2">
                  <button class="respond-qa btn bg-rose-600 text-white" data-id="${it.id}" data-base="${basePath}">Save Response</button>
                  <button class="delete-qa btn bg-white border" data-id="${it.id}" data-base="${basePath}">Delete question</button>
                </div>
              </div>
            </div>
          </div>
        `;
        qaList.appendChild(el);
      });

      qaList.querySelectorAll('.respond-qa').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          const textarea = qaList.querySelector(`textarea[data-id="${id}"]`);
          if (!textarea) return;
          const text = textarea.value.trim();
          if (!confirm('Save response to this question?')) return;
          try {
            const { doc: docRefFunc, updateDoc: updateDocFunc, serverTimestamp: serverTs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(m => ({ doc: m.doc, updateDoc: m.updateDoc, serverTimestamp: m.serverTimestamp }));
            const fullPath = `${basePath}/${id}`;
            await updateDocFunc(docRefFunc(db, fullPath), { adminResponse: text, responder: auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin', respondedAt: serverTs() });
            alert('Response saved.');
            loadQA();
          } catch (err) {
            console.error('Save response failed', err);
            alert('Could not save response: ' + (err.message || err.code || err));
          }
        });
      });

      qaList.querySelectorAll('.delete-qa').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const basePath = e.currentTarget.getAttribute('data-base');
          if (!confirm('Delete question?')) return;
          try {
            const { doc: docRefFunc, deleteDoc: deleteDocFunc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(m => ({ doc: m.doc, deleteDoc: m.deleteDoc }));
            const fullPath = `${basePath}/${id}`;
            await deleteDocFunc(docRefFunc(db, fullPath));
            loadQA();
          } catch (err) {
            console.error('Delete failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // ---------- MEDIA / COLLABS: Cloudinary unsigned upload + Firestore metadata ----------
    // Firestore path for collabs (we use the artifacts path directly)
    const COLLABS_COLLECTION_PATH = `artifacts/${APP_ID}/public/data/collabs`;

    // helper to show collabs realtime
    let collabsUnsub = null;
    function subscribeCollabs() {
      collabsError.classList.add('hidden-el');
      collabsList.innerHTML = '<div class="small-muted">Loading collabs…</div>';
      // unsubscribe if exists
      if (collabsUnsub) collabsUnsub();

      try {
        collabsUnsub = onSnapshot(collection(db, COLLABS_COLLECTION_PATH), (snap) => {
          const docs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
          // newest first
          docs.sort((a,b) => {
            const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
            const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
            return tb - ta;
          });
          renderCollabs(docs);
        }, (err) => {
          console.error('collabs onSnapshot error', err);
          collabsList.innerHTML = '<div class="small-muted">Could not load collabs.</div>';
          collabsError.classList.remove('hidden-el');
          collabsError.textContent = 'Realtime read failed: ' + (err.message || err.code || err);
        });
      } catch (err) {
        console.error('subscribeCollabs error', err);
        collabsList.innerHTML = '<div class="small-muted">Could not load collabs.</div>';
        collabsError.classList.remove('hidden-el');
        collabsError.textContent = 'Could not subscribe to collabs: ' + (err.message || err.code || err);
      }
    }

    function renderCollabs(docs) {
      collabsList.innerHTML = '';
      if (!docs || !docs.length) {
        collabsList.innerHTML = '<div class="small-muted">No collabs yet.</div>';
        return;
      }
      docs.forEach(item => {
        const d = item.data || {};
        const createdAt = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : '';
        const caption = d.caption || '';
        const imageUrl = d.imageUrl || '';
        const publicId = d.publicId || '';

        const card = document.createElement('div');
        card.className = 'collab-card';
        card.innerHTML = `
          <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(caption || 'Collab image')}" class="collab-thumb" onerror="this.style.opacity=.6;this.style.objectFit='contain';this.src='https://via.placeholder.com/640x360?text=image'"/>
          <div class="collab-body">
            <div style="font-weight:700;">${escapeHtml(caption || '(no caption)')}</div>
            <div class="collab-meta">${escapeHtml(createdAt)} ${ publicId ? `<div style="font-size:.75rem;color:#94a3b8;margin-top:6px;">id: ${escapeHtml(publicId)}</div>` : '' }</div>
            <div style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn-delete-collab btn bg-white border" data-id="${item.id}" data-publicid="${escapeHtml(publicId)}">Delete</button>
            </div>
          </div>
        `;
        collabsList.appendChild(card);
      });

      // attach delete handlers (removes Firestore doc; Cloudinary asset remains until manually removed)
      collabsList.querySelectorAll('.btn-delete-collab').forEach(b => {
        b.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const publicId = e.currentTarget.getAttribute('data-publicid');
          if (!confirm('Delete this collab entry? This removes it from the site. (Cloudinary file will remain unless removed from Cloudinary dashboard)')) return;
          try {
            const { doc: docRefFunc, deleteDoc: deleteDocFunc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(m => ({ doc: m.doc, deleteDoc: m.deleteDoc }));
            const fullPath = `${COLLABS_COLLECTION_PATH}/${id}`;
            await deleteDocFunc(docRefFunc(db, fullPath));
            // NOTE: cannot delete Cloudinary resource client-side without API secret.
            alert('Collab removed from Firestore. To fully delete the file from Cloudinary, remove it from your Cloudinary dashboard using public_id: ' + publicId);
          } catch (err) {
            console.error('Delete collab failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // upload handler: unsigned Cloudinary upload then save doc
    collabForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      collabStatus.textContent = '';
      collabsError.classList.add('hidden-el');

      if (!CLOUDINARY_CLOUD_NAME || CLOUDINARY_CLOUD_NAME === 'YOUR_CLOUDINARY_CLOUD_NAME') {
        collabStatus.textContent = 'Please set CLOUDINARY_CLOUD_NAME in the admin file.';
        return;
      }

      const file = collabFile.files && collabFile.files[0];
      if (!file) {
        collabStatus.textContent = 'Please choose an image file.';
        return;
      }

      uploadCollabBtn.disabled = true;
      collabStatus.textContent = 'Uploading to Cloudinary...';

      try {
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', CLOUDINARY_UNSIGNED_PRESET);
        // optional: add folder
        form.append('folder', 'collabs');

        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
        const res = await fetch(url, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Cloudinary upload failed: ' + res.statusText);
        const json = await res.json();

        const imageUrl = json.secure_url || json.url || '';
        const publicId = json.public_id || '';

        collabStatus.textContent = 'Saving to Firestore...';

        // add doc to Firestore collabs collection path
        await addDoc(collection(db, COLLABS_COLLECTION_PATH), {
          caption: collabCaption.value.trim() || '',
          imageUrl,
          publicId,
          uploader: auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin',
          createdAt: serverTimestamp()
        });

        collabStatus.textContent = 'Uploaded & saved.';
        collabFile.value = '';
        collabCaption.value = '';
      } catch (err) {
        console.error('Upload/save error', err);
        collabsError.classList.remove('hidden-el');
        collabsError.textContent = 'Upload or save failed: ' + (err.message || err.code || err);
      } finally {
        uploadCollabBtn.disabled = false;
        setTimeout(()=>{ collabStatus.textContent = ''; }, 2000);
      }
    });

    // fallback subscribe on page show (if admin opens media pane)
    // ensure anonymous auth if needed
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // try anonymous sign-in to allow reads if rules permit
        signInAnonymously(auth).catch(err => {
          console.warn('Anonymous sign-in failed (continuing read-only where possible):', err);
        });
      }
    });

    // initialize: keep QA & Support functionality alive but only subscribe when panes open.
    // (QA & Support functions already defined above)

  </script>
</body>
</html>
