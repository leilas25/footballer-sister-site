<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="data:,">
  <style>
    .fade-in { animation: fade .25s ease-out; }
    @keyframes fade { from {opacity:0; transform:translateY(4px)} to {opacity:1; transform:none} }
    .logo-preview { width: 32px; height: 32px; border-radius: 9999px; object-fit: cover; background: #f3f4f6; }
  </style>
</head>

<body class="bg-pink-50 text-black font-sans min-h-screen flex flex-col">
  <!-- Header -->
  <header class="fixed top-0 w-full flex justify-between items-center px-6 py-4 bg-pink-100 shadow z-50">
    <h1 class="text-xl font-bold uppercase text-rose-600">Admin • The Footballer’s Sister</h1>
    <nav class="space-x-6">
      <a href="index.html" class="hover:underline text-rose-600">Home</a>
    </nav>
  </header>

  <!-- LOGIN -->
  <main id="loginSection" class="flex-grow pt-32 px-6 pb-20">
    <div class="max-w-sm mx-auto bg-white rounded-xl shadow p-6 fade-in">
      <h2 class="text-2xl font-bold text-rose-700 mb-2">Admin Login</h2>
      <p class="text-sm text-gray-600 mb-4">Sign in with your admin email & password.</p>
      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" required placeholder="Email"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <input id="password" type="password" required placeholder="Password"
               class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <button class="w-full bg-rose-600 text-white px-6 py-3 rounded-full hover:bg-rose-700 font-semibold">
          Log in
        </button>
      </form>
      <p id="loginError" class="text-red-600 text-sm mt-3 hidden"></p>
    </div>
  </main>

  <!-- NO ACCESS -->
  <section id="noAccess" class="hidden flex-grow pt-32 px-6 pb-20 text-center">
    <h2 class="text-2xl font-bold text-rose-700 mb-2">No Access</h2>
    <p class="text-gray-700">This account is not authorized to use the admin panel.</p>
    <button id="logoutNoAccess" class="mt-6 bg-gray-200 text-gray-900 px-4 py-2 rounded-full hover:bg-gray-300">
      Log out
    </button>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="adminPanel" class="hidden flex-grow pt-32 px-6 pb-20 max-w-5xl mx-auto fade-in">
    <div class="flex items-center justify-between mb-6">
      <div class="flex flex-wrap gap-3">
        <button data-tab="support"  class="tab-btn bg-rose-600 text-white px-4 py-2 rounded-full">Support Wall</button>
        <button data-tab="qa"       class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Q&A</button>
        <button data-tab="fixtures" class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Fixtures</button>
      </div>
      <button id="logoutBtn" class="bg-rose-600 text-white px-4 py-2 rounded-full hover:bg-rose-700">Log out</button>
    </div>

    <!-- Support Wall -->
    <div id="tab-support">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Support Wall – Moderate</h2>
      <div id="supportList" class="space-y-3"><p class="text-gray-500">Loading…</p></div>
    </div>

    <!-- Q&A -->
    <div id="tab-qa" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-rose-700">Q&A – Answer & Moderate</h2>
        <div class="flex gap-2">
          <button data-filter="all"         class="qa-filter px-3 py-1 rounded-full bg-rose-600 text-white">All</button>
          <button data-filter="unanswered"  class="qa-filter px-3 py-1 rounded-full bg-gray-200 text-gray-900">Unanswered</button>
          <button data-filter="answered"    class="qa-filter px-3 py-1 rounded-full bg-gray-200 text-gray-900">Answered</button>
        </div>
      </div>
      <p id="qaCounts" class="text-xs text-gray-500 mb-2">Totals: —</p>
      <div id="qaList" class="space-y-3"><p class="text-gray-500">Loading…</p></div>
    </div>

    <!-- FIXTURES -->
    <div id="tab-fixtures" class="hidden">
      <h2 class="text-2xl font-bold text-rose-700 mb-4">Fixtures – Add / Update</h2>
      <form id="fxForm" class="grid md:grid-cols-2 gap-3 bg-white p-4 rounded-xl border shadow mb-6">
        <input type="hidden" id="fxId" />
        <div>
          <label class="text-sm">Team Level</label>
          <select id="fxLevel" class="w-full border rounded px-3 py-2">
            <option>U14</option>
            <option>U19</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Opponent</label>
          <input id="fxOpponent" class="w-full border rounded px-3 py-2" placeholder="e.g. Kaizer Chiefs U14"/>
        </div>
        <div>
          <label class="text-sm">Home/Away</label>
          <select id="fxHa" class="w-full border rounded px-3 py-2">
            <option value="home">Home</option>
            <option value="away">Away</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Venue</label>
          <input id="fxVenue" class="w-full border rounded px-3 py-2" placeholder="e.g. Rand Stadium"/>
        </div>
        <div>
          <label class="text-sm">Date & Time</label>
          <input id="fxDateTime" type="datetime-local" class="w-full border rounded px-3 py-2"/>
        </div>
        <div>
          <label class="text-sm">Competition</label>
          <input id="fxComp" class="w-full border rounded px-3 py-2" placeholder="e.g. GDL League"/>
        </div>
        <div>
          <label class="text-sm">Jomo Cosmos Logo URL (auto)</label>
          <input id="fxHomeLogoUrl" class="w-full border rounded px-3 py-2" placeholder="/images/jc-u14.png"/>
        </div>
        <div>
          <label class="text-sm">Opponent Logo URL</label>
          <input id="fxAwayLogoUrl" class="w-full border rounded px-3 py-2" placeholder="https://... or /images/opponent.png"/>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm">Stream URL</label>
          <input id="fxStream" class="w-full border rounded px-3 py-2" placeholder="https://..."/>
        </div>
        <div class="flex gap-2 md:col-span-2">
          <button id="fxSave" type="submit" class="bg-rose-600 text-white px-4 py-2 rounded hover:bg-rose-700">Save</button>
          <button type="button" id="fxReset" class="bg-gray-200 text-gray-900 px-4 py-2 rounded">Reset</button>
        </div>
      </form>
      <div id="fxList" class="space-y-3"></div>
    </div>
  </section>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; <span id="year"></span> The Footballer’s Sister. All rights reserved.</p>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- FIREBASE ADMIN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, addDoc,
      serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* Only this UID can moderate */
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";

    /* Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db"
    };

    /* Firestore paths (SHORT appId) */
    const APP_ID   = "1:65396604482:web:0f31625a714aa8352337db";
    const QUESTIONS_PATH = `artifacts/${APP_ID}/public/data/questions`;
    const SUPPORT_PATH   = `artifacts/${APP_ID}/public/data/supportMessages`;
    const FIXTURES_PATH  = `artifacts/${APP_ID}/public/data/fixtures`;

    /* JC logo defaults */
    const JC_LOGO_U14 = "/images/jc-u14.png";
    const JC_LOGO_U19 = "/images/jc-u19.png";

    /* Init */
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    /* UI refs */
    const loginSection = document.getElementById('loginSection');
    const adminPanel   = document.getElementById('adminPanel');
    const noAccess     = document.getElementById('noAccess');
    const loginForm    = document.getElementById('loginForm');
    const loginError   = document.getElementById('loginError');
    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutNo     = document.getElementById('logoutNoAccess');

    const supportList  = document.getElementById('supportList');
    const qaList       = document.getElementById('qaList');
    const qaCountsEl   = document.getElementById('qaCounts');

    // Fixtures refs
    const fxList     = document.getElementById('fxList');
    const fxForm     = document.getElementById('fxForm');
    const fxId       = document.getElementById('fxId');
    const fxLevel    = document.getElementById('fxLevel');
    const fxOpponent = document.getElementById('fxOpponent');
    const fxHa       = document.getElementById('fxHa');
    const fxVenue    = document.getElementById('fxVenue');
    const fxDateTime = document.getElementById('fxDateTime');
    const fxStream   = document.getElementById('fxStream');
    const fxComp     = document.getElementById('fxComp');
    const fxHomeLogoUrl = document.getElementById('fxHomeLogoUrl');
    const fxAwayLogoUrl = document.getElementById('fxAwayLogoUrl');

    let qaItems = [];
    let qaFilter = 'all';
    let fixtures = [];

    const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    const badgeClass = st => st==='live' ? 'bg-green-100 text-green-700'
                         : st==='finished' ? 'bg-gray-100 text-gray-700'
                         : 'bg-blue-100 text-blue-700';

    function setView(v) {
      loginSection.classList.toggle('hidden', v !== 'login');
      adminPanel.classList.toggle('hidden', v !== 'admin');
      noAccess.classList.toggle('hidden', v !== 'noaccess');
    }

    /* Auth state */
    onAuthStateChanged(auth, user => {
      if (!user) return setView('login');
      if (user.uid === ADMIN_UID) { setView('admin'); startListeners(); }
      else setView('noaccess');
    });

    /* Login */
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      loginError.classList.add('hidden');
      try {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = err.message;
        loginError.classList.remove('hidden');
      }
    });
    logoutBtn.onclick = () => signOut(auth);
    logoutNo.onclick  = () => signOut(auth);

    /* ---------------- Support Wall ---------------- */
    function renderSupport(list) {
      supportList.innerHTML = '';
      if (!list.length) {
        supportList.innerHTML = '<p class="text-gray-500">No messages yet.</p>';
        return;
      }
      list.forEach(({ id, data }) => {
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-2xl p-4 shadow';
        card.innerHTML = `
          <strong>${esc(data.name||'Anonymous')}</strong>
          <p class="text-gray-700 mt-1">${esc(data.message||'')}</p>
          <div class="mt-2 flex gap-2">
            <button class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
          </div>
        `;
        card.querySelector('button').addEventListener('click', async () => {
          if (confirm('Delete message?')) await deleteDoc(doc(db, SUPPORT_PATH, id));
        });
        supportList.appendChild(card);
      });
    }

    /* ---------------- Q&A ---------------- */
    function applyFilter(items, filter) {
      if (filter === 'answered')   return items.filter(x => !!x.data.answer);
      if (filter === 'unanswered') return items.filter(x => !x.data.answer);
      return items;
    }
    function renderQACounts(items) {
      const total = items.length;
      const answered = items.filter(x => !!x.data.answer).length;
      const unanswered = total - answered;
      qaCountsEl.textContent = `Totals: All ${total} • Unanswered ${unanswered} • Answered ${answered}`;
    }
    function renderQuestions() {
      const items = applyFilter(qaItems, qaFilter);
      renderQACounts(qaItems);

      qaList.innerHTML = '';
      if (!items.length) {
        qaList.innerHTML = '<p class="text-gray-500">No questions yet.</p>';
        return;
      }

      items.forEach(({ id, data }) => {
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-2xl p-4 shadow';
        const hasAnswer = !!data.answer;
        card.innerHTML = `
          <strong>${esc(data.name||'Anonymous')}</strong>
          <p class="text-gray-800 mt-1">${esc(data.question||'')}</p>
          ${hasAnswer
            ? `<div class="bg-pink-50 mt-2 p-2 rounded"><strong>Answer:</strong> ${esc(data.answer)}</div>`
            : `<textarea class="border w-full p-2 mt-2 rounded" placeholder="Type your answer"></textarea>
               <button class="bg-rose-600 text-white px-3 py-1 mt-2 rounded">Save Answer</button>`}
          <button class="mt-2 bg-red-600 text-white px-3 py-1 rounded">Delete</button>
        `;
        const btns = card.querySelectorAll('button');
        if (!hasAnswer) {
          const textarea = card.querySelector('textarea');
          btns[0].addEventListener('click', async () => {
            const ans = textarea.value.trim();
            if (!ans) return alert('Please write an answer.');
            await updateDoc(doc(db, QUESTIONS_PATH, id), { answer: ans, answeredAt: serverTimestamp() });
          });
          btns[1].addEventListener('click', async () => {
            if (confirm('Delete question?')) await deleteDoc(doc(db, QUESTIONS_PATH, id));
          });
        } else {
          btns[0].addEventListener('click', async () => {
            if (confirm('Delete question?')) await deleteDoc(doc(db, QUESTIONS_PATH, id));
          });
        }
        qaList.appendChild(card);
      });
    }

    /* ---------------- Fixtures ---------------- */
    // Live listener
    onSnapshot(collection(db, FIXTURES_PATH), snap => {
      fixtures = snap.docs.map(d=>({id:d.id, ...d.data()}))
        .sort((a,b)=> (a.kickoffTs?.seconds ?? 0) - (b.kickoffTs?.seconds ?? 0));
      renderFixtures();
    });

    fxLevel.addEventListener('change', () => {
      const def = fxLevel.value === 'U14' ? JC_LOGO_U14 : JC_LOGO_U19;
      if (!fxHomeLogoUrl.value || fxHomeLogoUrl.value === JC_LOGO_U14 || fxHomeLogoUrl.value === JC_LOGO_U19) {
        fxHomeLogoUrl.value = def;
      }
    });

    fxForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = readForm();
      if (!payload.opponent || !payload.kickoffTs) return alert('Please add opponent and date/time');
      if (fxId.value) {
        await updateDoc(doc(db, FIXTURES_PATH, fxId.value), payload);
      } else {
        await addDoc(collection(db, FIXTURES_PATH), {...payload, createdAt: serverTimestamp(), status:'scheduled'});
      }
      fxForm.reset(); fxId.value='';
    });
    document.getElementById('fxReset').addEventListener('click', (e)=>{ e.preventDefault(); fxForm.reset(); fxId.value=''; });

    function readForm(){
      const dt = fxDateTime.value ? new Date(fxDateTime.value) : null;
      const defHome = fxLevel.value === 'U14' ? JC_LOGO_U14 : JC_LOGO_U19;
      return {
        level: fxLevel.value,
        opponent: fxOpponent.value.trim(),
        homeAway: fxHa.value,
        venue: fxVenue.value.trim(),
        competition: fxComp.value.trim() || null,
        streamUrl: fxStream.value.trim() || null,
        kickoffTs: dt ? Timestamp.fromDate(dt) : null,
        homeLogoUrl: (fxHomeLogoUrl.value.trim() || defHome),
        awayLogoUrl: fxAwayLogoUrl.value.trim() || null
      };
    }

    function renderFixtures() {
      fxList.innerHTML = '';
      if (!fixtures.length) {
        fxList.innerHTML = `<p class="text-gray-500">No fixtures yet. Add one above.</p>`;
        return;
      }
      fixtures.forEach(f => {
        const when = f.kickoffTs?.toDate ? f.kickoffTs.toDate().toLocaleString() : '';
        const sc = (f.status==='live' || f.status==='finished') ? ` ${f.scoreHome ?? 0} : ${f.scoreAway ?? 0}` : '';
        const homeLogo = f.homeLogoUrl || '/images/jc-default.png';
        const awayLogo = f.awayLogoUrl || '/images/opponent.png';

        const card = document.createElement('div');
        card.className = 'bg-white border rounded-xl p-4 shadow';
        card.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm text-gray-500">${when} • ${esc(f.venue||'')}</div>

              <div class="flex items-center justify-between gap-3 mt-1">
                <div class="flex items-center gap-2">
                  <img src="${esc(homeLogo)}" alt="Jomo Cosmos" class="logo-preview" onerror="this.style.visibility='hidden'"/>
                  <div class="text-sm text-gray-700">Jomo Cosmos ${esc(f.level||'')} ${f.homeAway==='home'?'(Home)':'(Away)'}</div>
                </div>
                <div class="text-xs text-gray-500">vs</div>
                <div class="flex items-center gap-2">
                  <div class="text-sm text-gray-700">${esc(f.opponent||'')}</div>
                  <img src="${esc(awayLogo)}" alt="Opponent" class="logo-preview" onerror="this.style.visibility='hidden'"/>
                </div>
              </div>

              <div class="text-sm text-gray-600 mt-1">
                ${esc(f.competition||'')}
                ${f.status ? ` <span class="ml-1 text-xs px-2 py-0.5 rounded-full ${badgeClass(f.status)}">${f.status.toUpperCase()}</span>`:''}
                ${sc ? `<span class="ml-1 font-bold">${sc}</span>` : ''}
              </div>

              ${f.streamUrl ? `<a target="_blank" href="${esc(f.streamUrl)}" class="inline-block mt-2 px-3 py-1 rounded-full text-sm bg-rose-600 text-white hover:bg-rose-700">Watch link</a>`:''}
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-1 rounded bg-gray-200" data-edit>Edit</button>
              <button class="px-3 py-1 rounded bg-red-600 text-white" data-del>Delete</button>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button class="px-3 py-1 rounded bg-green-600 text-white" data-live>Go LIVE</button>
            <button class="px-3 py-1 rounded bg-gray-200" data-ft>Mark FT</button>
            <input class="w-20 border rounded px-2 py-1" placeholder="Home" value="${f.scoreHome ?? ''}" data-home />
            <input class="w-20 border rounded px-2 py-1" placeholder="Away" value="${f.scoreAway ?? ''}" data-away />
            <button class="px-3 py-1 rounded bg-rose-600 text-white" data-save-score>Save Score</button>
          </div>
        `;
        // Wire actions
        card.querySelector('[data-edit]').addEventListener('click', ()=>fillForm(f.id));
        card.querySelector('[data-del]').addEventListener('click', async ()=>{
          if (confirm('Delete this fixture?')) await deleteDoc(doc(db, FIXTURES_PATH, f.id));
        });
        card.querySelector('[data-live]').addEventListener('click', async ()=> {
          await updateDoc(doc(db, FIXTURES_PATH, f.id), { status: 'live' });
        });
        card.querySelector('[data-ft]').addEventListener('click', async ()=> {
          await updateDoc(doc(db, FIXTURES_PATH, f.id), { status: 'finished' });
        });
        card.querySelector('[data-save-score]').addEventListener('click', async ()=>{
          const home = Number(card.querySelector('[data-home]').value);
          const away = Number(card.querySelector('[data-away]').value);
          if (Number.isNaN(home) || Number.isNaN(away)) return alert('Scores must be numbers');
          await updateDoc(doc(db, FIXTURES_PATH, f.id), { scoreHome: home, scoreAway: away });
        });

        fxList.appendChild(card);
      });
    }

    function fillForm(id){
      const f = fixtures.find(x=>x.id===id); if (!f) return;
      fxId.value = id;
      fxLevel.value = f.level || 'U14';
      fxOpponent.value = f.opponent || '';
      fxHa.value = f.homeAway || 'home';
      fxVenue.value = f.venue || '';
      fxComp.value = f.competition || '';
      fxStream.value = f.streamUrl || '';
      fxHomeLogoUrl.value = f.homeLogoUrl || (fxLevel.value === 'U14' ? JC_LOGO_U14 : JC_LOGO_U19);
      fxAwayLogoUrl.value = f.awayLogoUrl || '';
      if (f.kickoffTs?.toDate){
        const d = f.kickoffTs.toDate();
        fxDateTime.value = d.toISOString().slice(0,16);
      }
      // switch to fixtures tab
      tabs.forEach(b=>b.classList.remove('bg-rose-600','text-white'));
      tabs.forEach(b=>b.classList.add('bg-gray-200','text-gray-900'));
      document.querySelector('[data-tab="fixtures"]').classList.add('bg-rose-600','text-white');
      Object.values(panels).forEach(p=>p.classList.add('hidden'));
      panels['fixtures'].classList.remove('hidden');
    }

    /* Start listeners after auth */
    function startListeners() {
      onSnapshot(collection(db, SUPPORT_PATH), snap => {
        renderSupport(snap.docs.map(d=>({id:d.id,data:d.data()})));
      });
      onSnapshot(collection(db, QUESTIONS_PATH), snap => {
        qaItems = snap.docs.map(d=>({id:d.id,data:d.data()}));
        renderQuestions();
      });
      // Fixtures listener already attached above
    }

    /* Filters (Q&A) */
    const filterBtns = document.querySelectorAll('.qa-filter');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('bg-rose-600','text-white'));
        filterBtns.forEach(b => b.classList.add('bg-gray-200','text-gray-900'));
        btn.classList.add('bg-rose-600','text-white');
        qaFilter = btn.dataset.filter;
        renderQuestions();
      });
    });

    /* Tabs */
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = {
      support:  document.getElementById('tab-support'),
      qa:       document.getElementById('tab-qa'),
      fixtures: document.getElementById('tab-fixtures')
    };
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('bg-rose-600','text-white'));
      tabs.forEach(b => b.classList.add('bg-gray-200','text-gray-900'));
      btn.classList.add('bg-rose-600','text-white');
      Object.values(panels).forEach(p=>p.classList.add('hidden'));
      panels[btn.dataset.tab].classList.remove('hidden');
    }));
  </script>
</body>
</html>
