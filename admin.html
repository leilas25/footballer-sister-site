<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex,nofollow"/>
  <style>.fade-in{animation:fade .25s ease-out}@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}</style>
</head>
<body class="bg-pink-50 text-black font-sans min-h-screen flex flex-col">
  <header class="fixed top-0 w-full flex justify-between items-center px-6 py-4 bg-pink-100 shadow z-50">
    <h1 class="text-xl font-bold uppercase text-rose-600">Admin • The Footballer’s Sister</h1>
    <nav class="space-x-3">
      <a href="index.html" class="hover:underline text-rose-600">Home</a>
      <button id="logoutBtn" class="bg-rose-600 text-white px-4 py-2 rounded-full hover:bg-rose-700">Log out</button>
    </nav>
  </header>

  <!-- LOGIN -->
  <main id="loginSection" class="flex-grow pt-32 px-6 pb-20">
    <div class="max-w-sm mx-auto bg-white rounded-xl shadow p-6 fade-in">
      <h2 class="text-2xl font-bold text-rose-700 mb-2">Admin Login</h2>
      <form id="loginForm" class="space-y-3">
        <input id="email" type="email" required placeholder="Email" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <input id="password" type="password" required placeholder="Password" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500"/>
        <button class="w-full bg-rose-600 text-white px-6 py-3 rounded-full hover:bg-rose-700 font-semibold">Log in</button>
      </form>
      <p id="loginError" class="text-red-600 text-sm mt-3 hidden"></p>
    </div>
  </main>

  <!-- NO ACCESS -->
  <section id="noAccess" class="hidden flex-grow pt-32 px-6 pb-20 text-center">
    <h2 class="text-2xl font-bold text-rose-700 mb-2">No Access</h2>
    <p class="text-gray-700">This account is not authorized.</p>
  </section>

  <!-- DASHBOARD -->
  <section id="adminPanel" class="hidden flex-grow pt-32 px-6 pb-20 max-w-6xl mx-auto fade-in">
    <div class="flex flex-wrap gap-3 mb-6">
      <button data-tab="support"  class="tab-btn bg-rose-600 text-white px-4 py-2 rounded-full">Support Wall</button>
      <button data-tab="qa"       class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Q&A</button>
      <button data-tab="fixtures" class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Fixtures</button>
      <button data-tab="giveaways"class="tab-btn bg-gray-200 text-gray-900 px-4 py-2 rounded-full">Giveaways</button>
    </div>

    <!-- Existing tabs you had (support / qa / fixtures) ... keep your previous content here -->
    <div id="tab-support"><p class="text-gray-500">Support wall moderation (unchanged).</p></div>
    <div id="tab-qa" class="hidden"><p class="text-gray-500">Q&A moderation (unchanged).</p></div>
    <div id="tab-fixtures" class="hidden"><p class="text-gray-500">Fixtures management (unchanged).</p></div>

    <!-- GIVEAWAYS TAB -->
    <div id="tab-giveaways" class="hidden">
      <h2 class="text-2xl font-bold text-rose-700 mb-4">Giveaways – Create & Manage</h2>

      <form id="gForm" class="grid md:grid-cols-2 gap-3 bg-white p-4 rounded-xl border shadow mb-6">
        <input type="hidden" id="gId"/>
        <div><label class="text-sm">Title</label><input id="gTitle" class="w-full border rounded px-3 py-2"/></div>
        <div><label class="text-sm">Subtitle</label><input id="gSub" class="w-full border rounded px-3 py-2"/></div>
        <div><label class="text-sm">Prize</label><input id="gPrize" class="w-full border rounded px-3 py-2" placeholder="e.g. Puma boots"/></div>
        <div><label class="text-sm">Image URL</label><input id="gImg" class="w-full border rounded px-3 py-2" placeholder="https://…"/></div>
        <div><label class="text-sm">Start</label><input id="gStart" type="datetime-local" class="w-full border rounded px-3 py-2"/></div>
        <div><label class="text-sm">End</label><input id="gEnd" type="datetime-local" class="w-full border rounded px-3 py-2"/></div>
        <div class="md:col-span-2">
          <label class="text-sm">Rules (one per line)</label>
          <textarea id="gRules" rows="3" class="w-full border rounded px-3 py-2" placeholder="Follow @…&#10;Tag 2 friends&#10;…"></textarea>
        </div>
        <div class="flex gap-2 md:col-span-2">
          <button class="bg-rose-600 text-white px-4 py-2 rounded hover:bg-rose-700">Save</button>
          <button type="button" id="gReset" class="bg-gray-200 text-gray-900 px-4 py-2 rounded">Reset</button>
        </div>
      </form>

      <div id="gList" class="space-y-4"></div>
    </div>
  </section>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; 2025 The Footballer’s Sister. All rights reserved.</p>
  </footer>

  <!-- Firebase Admin -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDoc, getDocs, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";
    const appId = "1:65396604482:web:0f31625a714aa8352337db";

    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);

    const loginSection=document.getElementById('loginSection');
    const adminPanel  =document.getElementById('adminPanel');
    const noAccess    =document.getElementById('noAccess');
    const loginForm   =document.getElementById('loginForm');
    const loginError  =document.getElementById('loginError');
    const logoutBtn   =document.getElementById('logoutBtn');

    function setView(v){
      loginSection.classList.toggle('hidden', v!=='login');
      adminPanel.classList.toggle('hidden', v!=='admin');
      noAccess.classList.toggle('hidden', v!=='noaccess');
    }

    onAuthStateChanged(auth, user=>{
      if(!user) return setView('login');
      if(user.uid===ADMIN_UID) setView('admin'); else setView('noaccess');
    });

    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      loginError.classList.add('hidden');
      try{
        const email=document.getElementById('email').value.trim();
        const password=document.getElementById('password').value;
        await signInWithEmailAndPassword(auth, email, password);
      }catch(err){
        loginError.textContent = err.message;
        loginError.classList.remove('hidden');
      }
    });
    logoutBtn.onclick=()=>signOut(auth);

    // Tabs
    const tabs=document.querySelectorAll('.tab-btn');
    const panels={support:document.getElementById('tab-support'), qa:document.getElementById('tab-qa'),
                  fixtures:document.getElementById('tab-fixtures'), giveaways:document.getElementById('tab-giveaways')};
    tabs.forEach(btn=>btn.onclick=()=>{
      tabs.forEach(b=>{b.classList.remove('bg-rose-600','text-white');b.classList.add('bg-gray-200','text-gray-900')});
      btn.classList.add('bg-rose-600','text-white');
      Object.values(panels).forEach(p=>p.classList.add('hidden'));
      panels[btn.dataset.tab].classList.remove('hidden');
    });

    // ---------- GIVEAWAYS ----------
    const gForm=document.getElementById('gForm');
    const gId  =document.getElementById('gId');
    const gTitle=document.getElementById('gTitle');
    const gSub  =document.getElementById('gSub');
    const gPrize=document.getElementById('gPrize');
    const gImg  =document.getElementById('gImg');
    const gStart=document.getElementById('gStart');
    const gEnd  =document.getElementById('gEnd');
    const gRules=document.getElementById('gRules');
    const gReset=document.getElementById('gReset');
    const gList =document.getElementById('gList');

    const G_PATH = `artifacts/${appId}/public/data/giveaways`;

    onSnapshot(collection(db, G_PATH), snap=>{
      const items = snap.docs.map(d=>({id:d.id, ...d.data()}))
        .sort((a,b)=> (a.endAt?.seconds||9999999999)-(b.endAt?.seconds||9999999999));
      renderGiveaways(items);
    });

    gForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const payload = {
        title: gTitle.value.trim(),
        subtitle: gSub.value.trim()||null,
        prize: gPrize.value.trim()||null,
        imageUrl: gImg.value.trim()||null,
        rules: gRules.value ? gRules.value.split('\n').map(s=>s.trim()).filter(Boolean) : [],
        startAt: gStart.value ? Timestamp.fromDate(new Date(gStart.value)) : null,
        endAt:   gEnd.value   ? Timestamp.fromDate(new Date(gEnd.value))   : null,
        updatedAt: serverTimestamp()
      };
      if(gId.value){
        await updateDoc(doc(db, G_PATH, gId.value), payload);
      }else{
        await addDoc(collection(db, G_PATH), { ...payload, createdAt: serverTimestamp(), winners: [] });
      }
      gForm.reset(); gId.value='';
    });
    gReset.onclick=()=>{gForm.reset(); gId.value='';};

    function renderGiveaways(items){
      gList.innerHTML='';
      if(!items.length){ gList.innerHTML='<p class="text-gray-500">No giveaways yet.</p>'; return; }

      items.forEach(g=>{
        const card=document.createElement('div');
        card.className='bg-white border rounded-xl p-4 shadow';
        card.innerHTML=`
          <div class="flex items-start gap-4">
            ${g.imageUrl? `<img src="${g.imageUrl}" class="w-24 h-24 object-cover rounded-lg">` : `<div class="w-24 h-24 rounded-lg bg-pink-100 flex items-center justify-center text-rose-600">No image</div>`}
            <div class="flex-1">
              <div class="font-semibold text-rose-700">${g.title||'Untitled'}</div>
              <div class="text-sm text-gray-600">${g.subtitle||''}</div>
              ${g.prize? `<div class="text-sm"><span class="font-semibold">Prize:</span> ${g.prize}</div>`:''}
              <div class="text-xs text-gray-500 mt-1">
                ${g.startAt?.toDate? 'Start: '+g.startAt.toDate().toLocaleString()+' • ' : ''}${g.endAt?.toDate? 'End: '+g.endAt.toDate().toLocaleString():''}
              </div>
              <div class="mt-2 flex flex-wrap gap-2">
                <button class="px-3 py-1 rounded bg-gray-200" data-edit="${g.id}">Edit</button>
                <button class="px-3 py-1 rounded bg-red-600 text-white" data-del="${g.id}">Delete</button>
                <button class="px-3 py-1 rounded bg-blue-600 text-white" data-entries="${g.id}">View Entries</button>
                <button class="px-3 py-1 rounded bg-purple-600 text-white" data-winners="${g.id}">Pick Winners</button>
              </div>
              ${Array.isArray(g.winners)&&g.winners.length? `<div class="mt-2 text-sm"><span class="font-semibold">Winners:</span> ${g.winners.map(w=>w.name||w.email||w.uid).join(', ')}</div>`:''}
            </div>
          </div>
        `;
        gList.appendChild(card);
      });

      // wire actions
      gList.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>fillForm(b.dataset.edit));
      gList.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delGiveaway(b.dataset.del));
      gList.querySelectorAll('[data-entries]').forEach(b=>b.onclick=()=>showEntries(b.dataset.entries));
      gList.querySelectorAll('[data-winners]').forEach(b=>b.onclick=()=>pickWinners(b.dataset.winners));
    }

    async function fillForm(id){
      const d=await getDoc(doc(db, G_PATH, id)); if(!d.exists()) return;
      const g=d.data(); gId.value=id;
      gTitle.value=g.title||''; gSub.value=g.subtitle||''; gPrize.value=g.prize||''; gImg.value=g.imageUrl||'';
      gRules.value=(Array.isArray(g.rules)?g.rules:[]).join('\n');
      if(g.startAt?.toDate) gStart.value=g.startAt.toDate().toISOString().slice(0,16);
      if(g.endAt?.toDate)   gEnd.value  =g.endAt.toDate().toISOString().slice(0,16);
      // jump to tab if needed
      tabs.forEach(b=>{b.classList.remove('bg-rose-600','text-white');b.classList.add('bg-gray-200','text-gray-900')});
      document.querySelector('[data-tab="giveaways"]').classList.add('bg-rose-600','text-white');
      Object.values(panels).forEach(p=>p.classList.add('hidden')); panels['giveaways'].classList.remove('hidden');
    }
    async function delGiveaway(id){
      if(!confirm('Delete this giveaway?')) return;
      await deleteDoc(doc(db, G_PATH, id));
    }
    async function showEntries(id){
      const snap = await getDocs(collection(db, `${G_PATH}/${id}/entries`));
      if(snap.empty){ alert('No entries yet.'); return; }
      const lines=[]; snap.forEach(d=>{const e=d.data(); lines.push(`${e.name||'-'} • ${e.email||'-'} • ${e.handle||'-'} • ${d.id}`)});
      alert(`Entries (${snap.size}):\n\n`+lines.join('\n'));
    }
    async function pickWinners(id){
      const count = Number(prompt('How many winners?', '1'))||1;
      const snap = await getDocs(collection(db, `${G_PATH}/${id}/entries`));
      const entries=snap.docs.map(d=>({uid:d.id, ...d.data()}));
      if(!entries.length){ alert('No entries to pick from.'); return; }
      // shuffle
      for(let i=entries.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [entries[i],entries[j]]=[entries[j],entries[i]]}
      const winners=entries.slice(0,Math.min(count,entries.length));
      await updateDoc(doc(db, G_PATH, id), { winners, winnersPickedAt: serverTimestamp() });
      alert('Winners saved:\n'+winners.map(w=>w.name||w.email||w.uid).join(', '));
    }
  </script>
</body>
</html>
