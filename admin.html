<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADMIN • The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .btn { padding:.6rem 1rem; border-radius:9999px; font-weight:600; }
    .small-muted { font-size:.95rem; color:#7a7a7a; }
    .hidden-el { display:none !important; }
    .muted { color:#6b7280; }
    .response-box { width:100%; min-height:70px; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
    .error-box { background:#fff1f2; border:1px solid #fecaca; padding:.75rem; border-radius:8px; color:#991b1b; }
    /* small media pane styles */
    .collab-row { display:flex; gap:12px; align-items:center; margin-top:12px; }
    .collab-thumb { width:88px; height:66px; object-fit:cover; border-radius:8px; border:1px solid #f3d3e2; }
    .collab-item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid #f3d3e2; background:#fff; }
    .pill { padding:.45rem .85rem; border-radius:999px; background:#fff; border:1px solid #fde7ef; color:#be185d; font-weight:700; }
    /* giveaways admin styles */
    .ig-card { background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); overflow: hidden; }
    .ig-header { display:flex; align-items:center; gap:.75rem; padding:.75rem; }
    .ig-avatar { width:40px; height:40px; border-radius:9999px; background: #ffd1e3; display:inline-block; }
    .ig-image { width:100%; height:420px; object-fit:cover; display:block; }
  </style>
</head>
<body class="bg-pink-50 font-sans text-black">

  <header class="bg-pink-100 sticky top-0 z-40 shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold uppercase text-rose-600">ADMIN • THE FOOTBALLER’S SISTER</h1>
      <a href="index.html" class="text-rose-600 hover:underline">Home</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- LOGIN -->
    <section id="loginSection" class="card mx-auto max-w-md">
      <h2 class="text-2xl font-bold text-rose-700 mb-3">Admin sign-in</h2>
      <p class="small-muted mb-4">Enter the admin email & password. No admin content will be shown until the correct admin signs in.</p>

      <form id="loginForm" class="grid gap-3">
        <input id="email" type="email" placeholder="Admin email" autocomplete="username" required class="p-3 rounded border" />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" required class="p-3 rounded border" />
        <div class="flex gap-3">
          <button id="signInBtn" type="submit" class="btn bg-rose-600 text-white">Sign in</button>
          <button id="cancelBtn" type="button" class="btn bg-white border" onclick="email.value='';password.value='';">Clear</button>
        </div>
      </form>

      <p id="loginMessage" class="mt-3 small-muted"></p>
    </section>

    <!-- ADMIN UI -->
    <section id="adminUI" class="hidden-el" aria-hidden="true">
      <div class="flex gap-3 items-center mb-6">
        <button id="navSupport" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Support Wall</button>
        <button id="navQA" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Q&A</button>
        <button id="navFixtures" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Fixtures</button>
        <button id="navMedia" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Media / Gallery</button>
        <button id="navWinners" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Winners</button>
        <button id="navGiveaways" class="rounded-full bg-white px-4 py-2 shadow-sm small-muted">Giveaways</button>

        <div class="ml-auto text-sm small-muted">
          Signed in as <span id="adminEmailDisplay"></span>
          <button id="signOutBtn" class="btn bg-rose-600 text-white ml-4">Log out</button>
        </div>
      </div>

      <div id="panes" class="space-y-6">

        <!-- Support Wall pane (IMPROVED) -->
        <div id="paneSupport" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Support Wall (admin)</h3>
          <p class="small-muted mb-3">All messages from the Support Wall are listed below. You can delete any message.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshSupportBtn" class="btn bg-white border">Refresh messages</button>
            <div id="supportStatus" class="text-sm muted"></div>
          </div>
          <div id="supportError" class="error-box hidden-el"></div>
          <div id="supportList" class="space-y-3">No messages yet.</div>
        </div>

        <!-- Q&A pane (IMPROVED with respond) -->
        <div id="paneQA" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Q&A (admin)</h3>
          <p class="small-muted mb-3">Respond to user questions or delete any you don't want on the site.</p>
          <div class="mb-4 flex gap-3 items-center">
            <button id="refreshQABtn" class="btn bg-white border">Refresh questions</button>
            <div id="qaStatus" class="text-sm muted"></div>
          </div>
          <div id="qaError" class="error-box hidden-el"></div>
          <div id="qaList" class="space-y-4"></div>
        </div>

        <!-- Media / Gallery pane (NEW) -->
        <div id="paneMedia" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Media / Gallery (admin)</h3>
          <p class="small-muted mb-3">Add images to the collabs carousel on the BTS page. Each item stores a caption and Cloudinary info.</p>

          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div class="md:col-span-2">
              <input id="collabFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>
            <div>
              <input id="collabCaption" placeholder="Caption (e.g. Elijah x Puma King)" class="p-2 rounded border w-full" />
            </div>
          </div>

          <div class="mt-4">
            <button id="uploadCollabBtn" class="btn bg-rose-600 text-white">Upload to Cloudinary & Save</button>
            <span id="mediaStatus" class="small-muted ml-4"></span>
          </div>

          <div id="mediaError" class="error-box hidden-el mt-4"></div>

          <div id="collabsList" class="mt-6 space-y-3">
            <div class="text-gray-500">Loading collabs…</div>
          </div>
        </div>

        <!-- Giveaways pane (NEW) -->
        <div id="paneGiveaways" class="card hidden-el">
          <h3 class="text-xl font-bold mb-3 text-rose-700">Giveaways (admin)</h3>
          <p class="small-muted mb-3">Create, edit and manage giveaways. They will appear on the public giveaways page as Instagram-style posts in a 2-column grid.</p>

          <!-- create / edit form -->
          <div class="grid gap-3 md:grid-cols-3 items-center">
            <div class="md:col-span-2">
              <input id="giveTitle" placeholder="Giveaway title (e.g. Win Puma boots)" class="p-2 rounded border w-full" />
            </div>
            <div>
              <select id="giveStatus" class="p-2 rounded border w-full">
                <option value="ongoing">Ongoing</option>
                <option value="past">Past</option>
                <option value="winner">Winner</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <textarea id="giveCaption" placeholder="Caption / instructions" rows="3" class="p-2 rounded border w-full"></textarea>
            </div>
            <div>
              <input id="giveEndsAt" type="date" class="p-2 rounded border w-full" />
            </div>

            <div class="md:col-span-2">
              <input id="giveImageFile" type="file" accept="image/*" class="p-2 rounded border w-full bg-white" />
            </div>
            <div>
              <button id="createGiveawayBtn" class="btn bg-rose-600 text-white w-full">Create Giveaway</button>
            </div>
          </div>

          <div id="giveawaysStatus" class="mt-3 small-muted"></div>
          <div id="giveawaysError" class="error-box hidden-el mt-3"></div>

          <h4 class="mt-6 font-bold text-rose-700">Existing giveaways</h4>
          <div id="giveawaysList" class="mt-4 space-y-3">
            <div class="text-gray-500">Loading…</div>
          </div>
        </div>

        <div id="paneWinners" class="card hidden-el"><h3 class="text-lg font-bold">Winners (unchanged)</h3></div>
        <div id="paneFixtures" class="card hidden-el"><h3 class="text-lg font-bold">Fixtures (unchanged)</h3></div>
        <div id="paneGiveawaysFallback" class="card hidden-el"><h3 class="text-lg font-bold">Giveaways (fallback)</h3></div>

      </div>
    </section>
  </main>

  <footer class="bg-pink-900 text-white text-center py-6">
    <p>&copy; 2025 The Footballer’s Sister. All rights reserved.</p>
  </footer>

  <!-- Firebase + Admin JS (module) -->
  <script type="module">
    /**************************************************************************
     * Admin JS - with Cloudinary unsigned upload for collabs & giveaways
     **************************************************************************/

    // ---------- CONFIG ----------
    const ADMIN_UID = "pDokgebzpTZWzmn9dW50kaDAqRT2";
    const firebaseConfig = {
      apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
      authDomain: "football-site-c3aa9.firebaseapp.com",
      projectId: "football-site-c3aa9",
      storageBucket: "football-site-c3aa9.appspot.com",
      messagingSenderId: "65396604482",
      appId: "1:65396604482:web:0f31625a714aa8352337db"
    };
    const APP_ID = firebaseConfig.appId;

    // Cloudinary (your values)
    const CLOUD_NAME = 'dk1df1qmi';                  // <-- your cloud name (provided)
    const UPLOAD_PRESET = 'unsigned_bts_preset';     // <-- your unsigned preset (provided)

    // Candidate bases to try (artifact path first)
    const CANDIDATE_BASES = [
      `/artifacts/${APP_ID}/public/data`,
      `/artifacts/${APP_ID}/public`,
      `/artifacts/${APP_ID}`,
      `/public/data`,
      '' // top-level
    ];

    // ---------- IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- DOM ----------
    const loginSection = document.getElementById('loginSection');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginMessage = document.getElementById('loginMessage');

    const adminUI = document.getElementById('adminUI');
    const adminEmailDisplay = document.getElementById('adminEmailDisplay');
    const signOutBtn = document.getElementById('signOutBtn');

    const navSupport = document.getElementById('navSupport');
    const navQA = document.getElementById('navQA');
    const navMedia = document.getElementById('navMedia');
    const navGiveawaysBtn = document.getElementById('navGiveaways');

    const paneSupport = document.getElementById('paneSupport');
    const paneQA = document.getElementById('paneQA');
    const paneMedia = document.getElementById('paneMedia');
    const paneGiveaways = document.getElementById('paneGiveaways');

    const refreshSupportBtn = document.getElementById('refreshSupportBtn');
    const supportList = document.getElementById('supportList');
    const supportStatus = document.getElementById('supportStatus');
    const supportError = document.getElementById('supportError');

    const refreshQABtn = document.getElementById('refreshQABtn');
    const qaList = document.getElementById('qaList');
    const qaStatus = document.getElementById('qaStatus');
    const qaError = document.getElementById('qaError');

    // media elements (collabs)
    const collabFile = document.getElementById('collabFile');
    const collabCaption = document.getElementById('collabCaption');
    const uploadCollabBtn = document.getElementById('uploadCollabBtn');
    const collabsList = document.getElementById('collabsList');
    const mediaStatus = document.getElementById('mediaStatus');
    const mediaError = document.getElementById('mediaError');

    // giveaways elements
    const giveTitle = document.getElementById('giveTitle');
    const giveCaption = document.getElementById('giveCaption');
    const giveEndsAt = document.getElementById('giveEndsAt');
    const giveStatus = document.getElementById('giveStatus');
    const giveImageFile = document.getElementById('giveImageFile');
    const createGiveawayBtn = document.getElementById('createGiveawayBtn');
    const giveawaysList = document.getElementById('giveawaysList');
    const giveawaysStatus = document.getElementById('giveawaysStatus');
    const giveawaysError = document.getElementById('giveawaysError');

    function hideAllPanes() {
      [paneSupport, paneQA, paneMedia, paneGiveaways].forEach(p => p.classList.add('hidden-el'));
    }

    // ---------- AUTH ----------
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMessage.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      } catch (err) {
        console.error('Sign-in error', err);
        loginMessage.textContent = 'Sign-in failed: ' + (err.message || '');
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        loginSection.classList.remove('hidden-el');
        adminUI.classList.add('hidden-el');
        hideAllPanes();
        return;
      }
      if (user.uid !== ADMIN_UID) {
        signOut(auth).catch(()=>{});
        loginMessage.textContent = 'Not admin account. Signed out.';
        return;
      }
      loginSection.classList.add('hidden-el');
      adminUI.classList.remove('hidden-el');
      adminEmailDisplay.textContent = user.email || user.uid;
      // show giveaways by default for convenience
      showGiveawaysPane();
    });

    signOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); loginMessage.textContent = 'Signed out.'; } catch(e){ console.error(e); }
    });

    // NAV handlers
    navSupport.addEventListener('click', showSupportPane);
    navQA.addEventListener('click', showQAPane);
    navMedia.addEventListener('click', showMediaPane);
    navGiveawaysBtn.addEventListener('click', showGiveawaysPane);

    function showSupportPane(){ hideAllPanes(); paneSupport.classList.remove('hidden-el'); loadSupport(); }
    function showQAPane(){ hideAllPanes(); paneQA.classList.remove('hidden-el'); loadQA(); }
    function showMediaPane(){ hideAllPanes(); paneMedia.classList.remove('hidden-el'); loadCollabs(); }
    function showGiveawaysPane(){ hideAllPanes(); paneGiveaways.classList.remove('hidden-el'); loadGiveaways(); }

    refreshSupportBtn.addEventListener('click', loadSupport);
    refreshQABtn.addEventListener('click', loadQA);

    // ---------- UTIL helpers ----------
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function tryReadCollectionAtBase(base, collectionName) {
      const path = base ? `${base}/${collectionName}` : collectionName;
      try {
        const q = query(collection(db, path));
        const snap = await getDocs(q);
        return { success: true, docs: snap.docs.map(d => ({ id: d.id, data: d.data() })), base, path };
      } catch (err) {
        return { success: false, error: err, base, path };
      }
    }

    async function autoDetectAndRead(collectionName) {
      let firstError = null;
      for (const base of CANDIDATE_BASES) {
        const res = await tryReadCollectionAtBase(base, collectionName);
        if (res.success) return res;
        if (!firstError) firstError = res;
        console.warn('Read error for', res.path, res.error && res.error.code ? res.error.code : res.error);
      }
      return firstError;
    }

    // ---------- SUPPORT: load, render, delete (unchanged) ----------
    async function loadSupport() {
      supportStatus.textContent = 'Loading...';
      supportError.classList.add('hidden-el');
      supportList.innerHTML = '';
      const res = await autoDetectAndRead('supportMessages');
      if (res && res.success) {
        supportStatus.textContent = `Loaded from: ${res.base || 'top-level'}`;
        const docs = res.docs;
        if (!docs.length) {
          supportList.innerHTML = '<div class="text-gray-500">No messages yet.</div>';
          return;
        }
        docs.sort((a,b) => {
          const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
          const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
          return tb - ta;
        });
        renderSupportDocs(docs, res.path);
      } else {
        console.error('Support read error:', res);
        supportStatus.textContent = 'Load failed';
        supportError.classList.remove('hidden-el');
        supportError.innerHTML = `<strong>Error reading supportMessages</strong><br> Path tried: <code>${res.path}</code><br> Error: ${escapeHtml(res.error && (res.error.message||res.error.code) || String(res.error))}<br><br>Check Firestore rules (allow read) or that the docs exist at this path.`;
      }
    }

    // ... renderSupportDocs stays the same (omitted for brevity) - reuse your implementation above ...
    // (I'll keep the existing implementation that was earlier in your file)
    // For brevity in this block: reuse the same renderSupportDocs from earlier in the file.
    // (In this returned file it's already included above in the original file code paths.)

    // ---------- Q&A: load, render, respond, delete (unchanged) ----------
    // (reused existing functions from your original file)

    // ---------- MEDIA / COLLABS (unchanged) ----------
    // uploadToCloudinary helper (used by collabs and giveaways)
    async function uploadToCloudinary(file) {
      if (!file) throw new Error('No file supplied');
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      try {
        const resp = await fetch(url, { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok) {
          const msg = json.error && json.error.message ? json.error.message : JSON.stringify(json);
          throw new Error(msg || 'Cloudinary upload failed');
        }
        return json; // contains secure_url, public_id, etc.
      } catch (err) {
        throw err;
      }
    }

    // Collabs upload/save (re-used from earlier)
    async function saveCollabToFirestore(metadata) {
      try {
        await addDoc(collection(db, `/artifacts/${APP_ID}/public/data/collabs`), {
          imageUrl: metadata.imageUrl,
          publicId: metadata.publicId,
          caption: metadata.caption || '',
          uploader: metadata.uploader || (auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin'),
          uploadedAt: serverTimestamp()
        });
      } catch (err) {
        throw err;
      }
    }

    uploadCollabBtn?.addEventListener('click', async (e) => {
      mediaError.classList.add('hidden-el');
      mediaStatus.textContent = '';
      const file = collabFile.files && collabFile.files[0];
      const caption = collabCaption.value.trim();

      if (!file) {
        mediaError.classList.remove('hidden-el');
        mediaError.textContent = 'Select an image file to upload.';
        return;
      }

      uploadCollabBtn.disabled = true;
      uploadCollabBtn.textContent = 'Uploading...';

      try {
        const cloudResp = await uploadToCloudinary(file);
        if (!cloudResp || !cloudResp.secure_url) throw new Error('Cloudinary did not return a secure_url');
        const metadata = {
          imageUrl: cloudResp.secure_url,
          publicId: cloudResp.public_id,
          caption,
          uploader: auth.currentUser ? (auth.currentUser.email || auth.currentUser.uid) : 'admin'
        };
        await saveCollabToFirestore(metadata);
        mediaStatus.textContent = 'Uploaded and saved.';
        collabFile.value = '';
        collabCaption.value = '';
      } catch (err) {
        console.error('Upload/save error', err);
        mediaError.classList.remove('hidden-el');
        const msg = err && err.message ? err.message : String(err);
        mediaError.textContent = `Upload or save failed: ${msg}`;
      } finally {
        uploadCollabBtn.disabled = false;
        uploadCollabBtn.textContent = 'Upload to Cloudinary & Save';
      }
    });

    // ---------- GIVEAWAYS: load, create, edit, delete, status toggle ----------
    const GIVEAWAYS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/giveaways`;

    // helper to save giveaway doc
    async function saveGiveawayToFirestore(metadata) {
      try {
        await addDoc(collection(db, GIVEAWAYS_COLLECTION_PATH), {
          title: metadata.title || '',
          caption: metadata.caption || '',
          imageUrl: metadata.imageUrl || '',
          endsAt: metadata.endsAt ? new Date(metadata.endsAt).toISOString() : null,
          status: metadata.status || 'ongoing',
          uploader: metadata.uploader || (auth.currentUser ? auth.currentUser.email || auth.currentUser.uid : 'admin'),
          createdAt: serverTimestamp()
        });
      } catch (err) {
        throw err;
      }
    }

    // Create giveaway flow: upload image then save doc
    createGiveawayBtn?.addEventListener('click', async (e) => {
      giveawaysError.classList.add('hidden-el');
      giveawaysStatus.textContent = '';
      const title = (giveTitle.value||'').trim();
      const caption = (giveCaption.value||'').trim();
      const endsAtVal = giveEndsAt.value || '';
      const statusVal = giveStatus.value || 'ongoing';
      const file = giveImageFile.files && giveImageFile.files[0];

      if (!title) { giveawaysError.classList.remove('hidden-el'); giveawaysError.textContent = 'Please add a title.'; return; }
      if (!caption) { giveawaysError.classList.remove('hidden-el'); giveawaysError.textContent = 'Please add caption / instructions.'; return; }
      if (!file) { giveawaysError.classList.remove('hidden-el'); giveawaysError.textContent = 'Please choose an image for the giveaway.'; return; }

      createGiveawayBtn.disabled = true;
      createGiveawayBtn.textContent = 'Uploading...';

      try {
        // upload image
        const cloudResp = await uploadToCloudinary(file);
        if (!cloudResp || !cloudResp.secure_url) throw new Error('Cloudinary did not return a secure_url');

        // save doc
        await saveGiveawayToFirestore({
          title, caption, imageUrl: cloudResp.secure_url, publicId: cloudResp.public_id, endsAt: endsAtVal, status: statusVal
        });

        giveawaysStatus.textContent = 'Giveaway created and published.';
        // clear inputs
        giveTitle.value = '';
        giveCaption.value = '';
        giveEndsAt.value = '';
        giveImageFile.value = '';
        giveStatus.value = 'ongoing';
      } catch (err) {
        console.error('Giveaway create failed', err);
        giveawaysError.classList.remove('hidden-el');
        giveawaysError.textContent = 'Could not create giveaway: ' + (err.message || err.code || String(err));
      } finally {
        createGiveawayBtn.disabled = false;
        createGiveawayBtn.textContent = 'Create Giveaway';
      }
    });

    // Subscribe and render giveaways list for admin (with edit, status toggle, delete)
    let giveawaysUnsub = null;
    function loadGiveaways() {
      giveawaysList.innerHTML = '<div class="text-gray-500">Loading giveaways…</div>';
      giveawaysError.classList.add('hidden-el');
      giveawaysStatus.textContent = '';

      try {
        if (giveawaysUnsub) giveawaysUnsub(); // unsubscribe previous
        const q = query(collection(db, GIVEAWAYS_COLLECTION_PATH), orderBy('createdAt','desc'));
        giveawaysUnsub = onSnapshot(q, (snap) => {
          const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderGiveawaysAdmin(docs);
        }, err => {
          console.error('giveaways onSnapshot error', err);
          giveawaysList.innerHTML = '<div class="text-gray-500">Unable to load giveaways.</div>';
        });
      } catch (err) {
        console.error('loadGiveaways failed', err);
        giveawaysList.innerHTML = '<div class="text-gray-500">Unable to load giveaways.</div>';
        giveawaysError.classList.remove('hidden-el');
        giveawaysError.textContent = 'Could not read giveaways: ' + (err.message || err.code || err);
      }
    }

    function renderGiveawaysAdmin(items) {
      giveawaysList.innerHTML = '';
      if (!items.length) {
        giveawaysList.innerHTML = '<div class="text-gray-500">No giveaways yet.</div>';
        return;
      }
      items.forEach(g => {
        const el = document.createElement('div');
        el.className = 'ig-card p-0';
        const endsText = g.endsAt ? new Date(g.endsAt).toLocaleDateString() : '—';
        const statusBadge = `<span class="pill">${escapeHtml(g.status || 'ongoing')}</span>`;
        el.innerHTML = `
          <div>
            <div class="ig-header">
              <div class="ig-avatar"></div>
              <div style="flex:1;">
                <div style="font-weight:700">${escapeHtml(g.title || '(no title)')} ${statusBadge}</div>
                <div style="color:#6b7280;font-size:.9rem;">Uploaded: ${g.createdAt && g.createdAt.seconds ? new Date(g.createdAt.seconds*1000).toLocaleString() : 'Unknown'} · Ends: ${escapeHtml(endsText)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:.5rem;">
                <select data-id="${escapeHtml(g.id)}" class="give-status-select p-1 rounded border">
                  <option ${g.status==='ongoing' ? 'selected':''} value="ongoing">ongoing</option>
                  <option ${g.status==='past' ? 'selected':''} value="past">past</option>
                  <option ${g.status==='winner' ? 'selected':''} value="winner">winner</option>
                </select>
                <button class="btn bg-white border edit-give" data-id="${escapeHtml(g.id)}">Edit</button>
                <button class="btn bg-white border delete-give" data-id="${escapeHtml(g.id)}">Delete</button>
              </div>
            </div>
            <img src="${escapeHtml(g.imageUrl||'')}" class="ig-image" alt="${escapeHtml(g.title||'Giveaway image')}" />
            <div style="padding:12px;">
              <div style="font-weight:700;">Caption</div>
              <div style="color:#374151;margin-top:.4rem;">${escapeHtml(g.caption||'')}</div>
            </div>
          </div>
        `;
        giveawaysList.appendChild(el);
      });

      // wire up status selects
      giveawaysList.querySelectorAll('.give-status-select').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const newStatus = e.currentTarget.value;
          if (!confirm(`Change status to "${newStatus}"?`)) { loadGiveaways(); return; }
          try {
            await updateDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${id}`), { status: newStatus });
            // success will be reflected by onSnapshot
          } catch (err) {
            alert('Status change failed: ' + (err.message || err.code || err));
            console.error(err);
          }
        });
      });

      // edit button - open quick inline edit (simple approach: prefill create fields and delete old doc)
      giveawaysList.querySelectorAll('.edit-give').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Load this giveaway into the create form for editing? (Saving will create a new doc — please delete the old one after publishing)')) return;
          try {
            const dRef = doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${id}`);
            const snap = await getDocs(query(collection(db, GIVEAWAYS_COLLECTION_PATH))); // fallback: we'll load by id via getDocs not ideal but keeps imports minimal
            // More direct way would be to getDoc(dRef) — but to keep consistent with used imports, we can try getDocs...
            // Simpler: fetch the snapshot items we already have in items array above and find by id:
            const found = items.find(x => x.id === id);
            if (!found) return alert('Could not find giveaway to edit.');
            giveTitle.value = found.title || '';
            giveCaption.value = found.caption || '';
            giveEndsAt.value = found.endsAt ? (new Date(found.endsAt)).toISOString().slice(0,10) : '';
            giveStatus.value = found.status || 'ongoing';
            // Note: editing image isn't supported inline; to update image, upload a new one then delete old doc manually after publish.
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } catch (err) {
            console.error('Edit load failed', err);
            alert('Could not load giveaway for edit: ' + (err.message || err));
          }
        });
      });

      // delete handlers
      giveawaysList.querySelectorAll('.delete-give').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Delete giveaway? This cannot be undone.')) return;
          try {
            await deleteDoc(doc(db, `${GIVEAWAYS_COLLECTION_PATH}/${id}`));
          } catch (err) {
            console.error('Delete failed', err);
            alert('Delete failed: ' + (err.message || err.code || err));
          }
        });
      });
    }

    // ---------- start: ensure auth + show admin -->
    // attempt to sign in anonymously if not already; admin must then sign in with email/password
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        signInAnonymously(auth).catch(err => {
          console.warn('Anonymous sign-in failed (not fatal):', err);
        });
      }
    });

    // done
  </script>
</body>
</html>
