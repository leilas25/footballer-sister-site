<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Q&A – The Footballer’s Sister</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg: #fff7fb;
      --accent: #be185d;
      --muted: #6b7280;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(11,7,17,0.06);
    }
    body { background: #fff2f6; color: #111827; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    header {
      background: linear-gradient(180deg, rgba(246,213,239,0.6), rgba(255,241,248,0.6));
      border-bottom: 1px solid rgba(235,200,215,0.6);
      backdrop-filter: blur(4px);
    }
    .site-title { color: var(--accent); font-weight: 800; letter-spacing: .02em; }
    main { padding-bottom: 6rem; }

    /* cards */
    .qa-card {
      background: var(--card);
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(235,224,232,0.6);
    }
    .qa-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    .qa-title { font-weight:800; font-size:1.05rem; color:#111827; }
    .qa-text { color:#374151; margin-top:.5rem; line-height:1.45; }
    .meta-row { display:flex; gap:.75rem; align-items:center; margin-top:.65rem; color:var(--muted); font-size:.9rem; }
    .chip-answered { background: linear-gradient(180deg,#ecfdf5,#dcfce7); color:#065f46; font-weight:700; padding:.4rem .6rem; border-radius:999px; font-size:.8rem; border:1px solid rgba(16,185,129,0.08); }
    .chip-unanswered { color:var(--muted); font-weight:600; font-size:.9rem; }

    /* layout */
    .container { max-width:920px; margin:0 auto; padding:2.25rem 1.5rem; }
    .page-head { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
    .page-h1 { font-size:2rem; font-weight:900; color:var(--accent); }
    .subtle { color:var(--muted); }

    /* pagination controls */
    .pager { display:flex; justify-content:center; margin-top:1.25rem; gap:.75rem; align-items:center; }
    .btn-pager { padding:.6rem 1rem; border-radius:999px; font-weight:700; background:white; border:1px solid rgba(0,0,0,0.06); cursor:pointer; box-shadow:0 6px 18px rgba(11,7,17,0.04); }
    .btn-primary { background: linear-gradient(90deg,#be185d,#f472b6); color:white; border:none; }

    /* navbar dropdown helper */
    .dropdown-open { opacity:1!important; transform:scale(1)!important; }

    /* responsive */
    @media (min-width:768px){
      .qa-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Header with dropdown -->
  <header class="sticky top-0 z-40">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding-top:1rem;padding-bottom:1rem;">
      <div style="display:flex;align-items:center;gap:1rem;">
        <div class="site-title" style="font-size:1.1rem;">THE FOOTBALLER’S SISTER</div>
      </div>

      <div class="relative inline-block text-left">
        <button id="navButton"
          class="inline-flex items-center justify-center rounded-md border border-pink-200 shadow-sm px-4 py-2 bg-white text-sm font-medium text-rose-600 hover:bg-pink-50 focus:outline-none">
          <span id="navTitle">Loading...</span>
          <svg class="-mr-1 ml-2 h-5 w-5 text-rose-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
          </svg>
        </button>

        <div id="dropdownMenu"
          class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 transform transition-all duration-200 ease-out scale-95 opacity-0">
          <div class="py-1">
            <a href="index.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Home</a>
            <a href="bts.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Behind the Game</a>
            <a href="leila.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Meet Leila</a>
            <a href="questions.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Q&A</a>
            <a href="support-wall.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Support Wall</a>
            <a href="fixtures.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Fixtures & Live Scores</a>
            <a href="giveaways.html" class="nav-item block px-4 py-2 text-sm text-gray-700 hover:bg-pink-50">Giveaways</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-head">
      <h1 class="page-h1">Q&amp;A</h1>
    </div>

    <section id="questionsSection" aria-label="Community questions">
      <div id="questionsList" class="qa-grid"></div>

      <div class="pager" id="pagerControls" style="display:none;">
        <button id="loadMoreBtn" class="btn-pager btn-primary">Load more</button>
        <button id="resetBtn" class="btn-pager" style="display:none;">Show fewer</button>
      </div>

      <p id="loading" class="subtle" style="margin-top:1.25rem;">Loading questions…</p>
      <p id="errorBox" class="subtle" style="margin-top:1rem; color:#b91c1c; display:none;"></p>
    </section>
  </main>

  <footer style="margin-top:3rem;">
    <div class="container" style="text-align:center;padding-top:1rem;padding-bottom:2rem;">
      <small style="color:rgba(255,255,255,0.95);background:linear-gradient(90deg,#be185d,#f472b6);padding:.4rem .8rem;border-radius:999px;">© <span id="year"></span> The Footballer’s Sister</small>
    </div>
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- Navbar dropdown script -->
  <script>
    (function () {
      const navButton = document.getElementById('navButton');
      const dropdownMenu = document.getElementById('dropdownMenu');
      const navItems = document.querySelectorAll('.nav-item');
      const navTitle = document.getElementById('navTitle');

      // determine current page (treat root "/" as index.html)
      let currentPage = window.location.pathname.split('/').pop();
      if (!currentPage || currentPage === '') currentPage = 'index.html';

      const pageTitles = {
        "index.html": "Home",
        "bts.html": "Behind the Game",
        "leila.html": "Meet Leila",
        "questions.html": "Q&A",
        "support-wall.html": "Support Wall",
        "fixtures.html": "Fixtures & Live Scores"
      };
      navTitle.textContent = pageTitles[currentPage] || "Menu";

      navItems.forEach(link => {
        const href = link.getAttribute('href');
        const hrefName = href.split('/').pop();
        if (hrefName === currentPage) {
          link.classList.add("font-semibold", "text-rose-600");
        }
      });

      navButton.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = dropdownMenu.classList.contains('hidden');
        if (isHidden) {
          dropdownMenu.classList.remove('hidden');
          setTimeout(()=>dropdownMenu.classList.add('dropdown-open'), 10);
        } else {
          dropdownMenu.classList.remove('dropdown-open');
          setTimeout(()=>dropdownMenu.classList.add('hidden'), 200);
        }
      });

      // close when clicking outside
      document.addEventListener('click', (e) => {
        if (!navButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove('dropdown-open');
          setTimeout(()=>dropdownMenu.classList.add('hidden'), 200);
        }
      });

      // close on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          dropdownMenu.classList.remove('dropdown-open');
          setTimeout(()=>dropdownMenu.classList.add('hidden'), 200);
        }
      });
    })();
  </script>

  <!-- Unified Firebase script: single init, form write + realtime listener -->
  <script type="module">
    (async () => {
      try {
        // dynamic imports (single place)
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, collection, addDoc, serverTimestamp, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

        // === your firebase config (unchanged) ===
        const firebaseConfig = {
          apiKey: "AIzaSyBiIvIHLYEQc0UGDcg4Qq0-w2Sv8NHmc6w",
          authDomain: "football-site-c3aa9.firebaseapp.com",
          projectId: "football-site-c3aa9",
          storageBucket: "football-site-c3aa9.appspot.com",
          messagingSenderId: "65396604482",
          appId: "1:65396604482:web:0f31625a714aa8357db"
        };
        // keep the same appId string you used for write-path generation
        const appId = '1:65396604482:web:0f31625a714aa8352337db';

        // Initialize app once
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // collection path (keeps the same structure you used)
        // NOTE: this matches the path used in your existing listener code
        const QUESTIONS_COLLECTION_PATH = `artifacts/${appId}/public/data/questions`;

        // DOM references (same IDs as your page)
        const qaForm = document.getElementById('qa-form');
        const qaStatus = document.getElementById('qa-status');
        const listEl = document.getElementById('questionsList');
        const loadingEl = document.getElementById('loading');
        const errorBox = document.getElementById('errorBox');
        const pagerControls = document.getElementById('pagerControls');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const resetBtn = document.getElementById('resetBtn');

        // pagination config (preserves your behavior)
        const itemsPerPage = 6;
        let visibleCount = itemsPerPage;
        let allDocs = [];

        // escape helper (preserve)
        function escapeHtml(str) {
          if (!str) return '';
          return String(str).replace(/[&<>"']/g, (s) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]);
        }

        // getQuestionText function (preserve)
        function getQuestionText(data) {
          if (!data || typeof data !== 'object') return '';

          const keys = [
            'body','message','question','text','q','description','content','msg',
            'questionText','question_text','questionBody','question_body','questionTxt',
            'question_message','message_text','bodyText','body_text','contentText','content_text',
            'ask','ask_text','userQuestion','user_question','input','questionValue'
          ];

          const hasKeyWithValue = (obj, key) => {
            if (!obj) return null;
            if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] && String(obj[key]).trim()) return String(obj[key]);
            const lower = key.toLowerCase();
            for (const k of Object.keys(obj)) {
              if (k.toLowerCase() === lower && obj[k] && String(obj[k]).trim()) return String(obj[k]);
            }
            return null;
          };

          for (const k of keys) {
            const v = hasKeyWithValue(data, k);
            if (v) return v;
          }
          for (const k of Object.keys(data)) {
            const v = data[k];
            if (typeof v === 'string' && v.trim()) return v;
          }
          for (const k of Object.keys(data)) {
            const v = data[k];
            if (v && typeof v === 'object') {
              for (const cand of keys) {
                const nested = hasKeyWithValue(v, cand);
                if (nested) return nested;
              }
              for (const nk of Object.keys(v)) {
                if (typeof v[nk] === 'string' && String(v[nk]).trim()) return v[nk];
              }
            }
          }
          const queue = [{obj:data,depth:0}];
          const seen = new Set();
          while (queue.length) {
            const {obj, depth} = queue.shift();
            if (!obj || typeof obj !== 'object' || depth > 2) continue;
            for (const key of Object.keys(obj)) {
              const val = obj[key];
              if (typeof val === 'string' && val.trim()) return val;
              if (val && typeof val === 'object' && !seen.has(val)) {
                seen.add(val);
                queue.push({obj: val, depth: depth + 1});
              }
            }
          }
          return '';
        }

        // renderVisible & updateDocs (preserve your UI logic exactly)
        function renderVisible() {
          if (!listEl) return;
          listEl.innerHTML = '';
          if (!allDocs || !allDocs.length) {
            listEl.innerHTML = '<div class="subtle">No questions yet.</div>';
            if (pagerControls) pagerControls.style.display = 'none';
            return;
          }

          const docs = allDocs.slice().sort((a,b) => {
            const ta = a.data.createdAt && a.data.createdAt.seconds ? a.data.createdAt.seconds : 0;
            const tb = b.data.createdAt && b.data.createdAt.seconds ? b.data.createdAt.seconds : 0;
            return tb - ta;
          });

          const slice = docs.slice(0, visibleCount);

          slice.forEach(it => {
            const d = it.data || {};
            const createdAt = d.createdAt && d.createdAt.seconds ? new Date(d.createdAt.seconds * 1000).toLocaleString() : '';
            const title = d.title || 'Question';
            const name = d.name || d.userName || d.user || d.username || '';
            const qText = getQuestionText(d);
            const adminResponse = d.adminResponse || null;

            const card = document.createElement('article');
            card.className = 'qa-card';
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
                <div style="flex:1;">
                  <div class="qa-title">${escapeHtml(title)}</div>
                  <div class="qa-text">${ qText ? escapeHtml(qText) : '<span class="subtle">[Question text unavailable]</span>' }</div>
                  <div class="meta-row">
                    ${ name ? `<div>Asked by ${escapeHtml(name)}</div>` : '' }
                    ${ createdAt ? `<div>· ${escapeHtml(createdAt)}</div>` : '' }
                  </div>
                </div>
                <div style="min-width:110px;text-align:right;">
                  ${ adminResponse ? '<div class="chip-answered">Answered</div>' : '<div class="chip-unanswered">Unanswered</div>' }
                </div>
              </div>
              ${ adminResponse ? `<div style="margin-top:1rem;padding:1rem;border-radius:10px;background:#f8fafc;border:1px solid rgba(226,232,240,0.6);"><strong>Reply:</strong> ${escapeHtml(adminResponse)}</div>` : '' }
            `;
            listEl.appendChild(card);
          });

          if (allDocs.length > itemsPerPage) {
            if (pagerControls) pagerControls.style.display = '';
            if (visibleCount >= allDocs.length) {
              if (loadMoreBtn) loadMoreBtn.style.display = 'none';
              if (resetBtn) resetBtn.style.display = '';
            } else {
              if (loadMoreBtn) loadMoreBtn.style.display = '';
              if (resetBtn) resetBtn.style.display = 'none';
            }
          } else {
            if (pagerControls) pagerControls.style.display = 'none';
          }
        }

        function updateDocs(newDocs) {
          allDocs = newDocs;
          if (visibleCount > allDocs.length) visibleCount = itemsPerPage;
          renderVisible();
        }

        // subscribe with realtime updates (onSnapshot)
        let unsubscribe = null;
        function subscribeToQuestions() {
          if (!db) return;
          if (unsubscribe) unsubscribe();
          if (loadingEl) loadingEl.style.display = '';
          if (errorBox) errorBox.style.display = 'none';

          try {
            const collRef = collection(db, QUESTIONS_COLLECTION_PATH);
            unsubscribe = onSnapshot(collRef, (snap) => {
              const docs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
              if (loadingEl) loadingEl.style.display = 'none';
              if (errorBox) errorBox.style.display = 'none';
              updateDocs(docs);
            }, (err) => {
              console.error('onSnapshot error', err);
              if (loadingEl) loadingEl.style.display = 'none';
              if (errorBox) { errorBox.style.display = ''; errorBox.textContent = 'Realtime read failed: ' + (err.message || err.code || err); }
            });
          } catch (err) {
            console.error('Subscribe failed', err);
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorBox) { errorBox.style.display = ''; errorBox.textContent = 'Could not subscribe to questions: ' + (err.message || err.code || err); }
          }
        }

        // pager handlers (preserve behavior)
        if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => {
          visibleCount = visibleCount + itemsPerPage;
          renderVisible();
          const questionsList = document.getElementById('questionsList');
          if (questionsList) window.scrollTo({ top: questionsList.offsetTop - 80, behavior: 'smooth' });
        });
        if (resetBtn) resetBtn.addEventListener('click', () => {
          visibleCount = itemsPerPage;
          renderVisible();
          const questionsList = document.getElementById('questionsList');
          if (questionsList) window.scrollTo({ top: questionsList.offsetTop - 80, behavior: 'smooth' });
        });

        // form submit handling (writes to the SAME collection used by onSnapshot)
        if (qaForm) {
          qaForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            if (qaStatus) qaStatus.textContent = 'Sending...';
            const name = (document.getElementById('qa-name') || {value:''}).value.trim();
            const title = (document.getElementById('qa-title') || {value:''}).value.trim();
            const question = (document.getElementById('qa-question') || {value:''}).value.trim();
            // keep same validation as before (requires both name and question)
            if (!name || !question) { if (qaStatus) qaStatus.textContent = 'Please add name & question.'; return; }
            try {
              await addDoc(collection(db, QUESTIONS_COLLECTION_PATH), {
                name,
                title,
                question,
                // add both fields so reads expecting createdAt will work,
                // and the older timestamp field remains present for compatibility
                createdAt: serverTimestamp(),
                timestamp: serverTimestamp()
              });
              if (qaStatus) qaStatus.textContent = 'Question sent — thank you!';
              qaForm.reset();
              setTimeout(()=>{ if (qaStatus) qaStatus.textContent = ''; }, 3500);
            } catch (err) {
              console.error('Failed to send question', err);
              if (qaStatus) qaStatus.textContent = 'Failed to send — check console.';
            }
          });
        }

        // auth + start subscription
        onAuthStateChanged(auth, (user) => {
          // always try to subscribe to read (read access can be public)
          subscribeToQuestions();
          if (!user) {
            signInAnonymously(auth).catch(err => {
              console.warn('Anonymous sign-in failed (continuing read-only):', err);
            });
          }
        });

      } catch (err) {
        // Firebase couldn't be loaded or module import failed — fallback UI behavior
        console.warn('Firebase Q&A not initialized:', err);
        const qaForm = document.getElementById('qa-form');
        const qaStatus = document.getElementById('qa-status');
        if (qaForm) {
          qaForm.addEventListener('submit', (ev) => {
            ev.preventDefault();
            if (qaStatus) qaStatus.textContent = 'Question handled locally (no Firebase).';
            setTimeout(()=>{ if (qaStatus) qaStatus.textContent = ''; }, 3000);
            qaForm.reset();
          });
        }
        // Optionally show an error in the questions area
        const loadingEl = document.getElementById('loading');
        const errorBox = document.getElementById('errorBox');
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorBox) { errorBox.style.display = ''; errorBox.textContent = 'Firebase unavailable — running in fallback mode.'; }
      }
    })();
  </script>
</body>
</html>
